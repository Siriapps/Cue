const k="cue_context_v1";function l(){return Date.now()}function A(t){return t.replace(/\s+/g," ").trim()}function v(t,s){return t.slice(0,s)}function P(){var t;try{return((t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)||null}catch{return null}}async function g(){const t=P();return t?new Promise(s=>{t.get([k],r=>{const e=r==null?void 0:r[k];if(!e||typeof e!="object"){s({recent_searches:[],recent_ai_chats:{},updatedAt:l()});return}s({recent_searches:Array.isArray(e.recent_searches)?e.recent_searches:[],recent_ai_chats:e.recent_ai_chats&&typeof e.recent_ai_chats=="object"?e.recent_ai_chats:{},updatedAt:typeof e.updatedAt=="number"?e.updatedAt:l()})})}):{recent_searches:[],recent_ai_chats:{},updatedAt:l()}}async function T(t){const s=P();if(s)return new Promise(r=>{s.set({[k]:{...t,updatedAt:l()}},()=>r())})}async function q(){await T({recent_searches:[],recent_ai_chats:{},updatedAt:l()})}async function G(t,s=50){const r=await g(),e=A(t.query);if(!e)return r;const o={...t,query:e,visitedAt:t.visitedAt||l()},n=r.recent_searches.filter(a=>!(a.query===o.query&&a.url===o.url)),c={...r,recent_searches:v([o,...n],s),updatedAt:l()};return await T(c),c}async function L(t,s=50){const r=await g(),e=t.map(a=>({query:A(a.query||""),url:a.url,engine:a.engine,visitedAt:a.visitedAt||l()})).filter(a=>!!a.query&&!!a.url),o=new Set,n=[];for(const a of e){const d=`${a.query}@@${a.url}`;if(!o.has(d)&&(o.add(d),n.push(a),n.length>=s))break}const c={...r,recent_searches:n,updatedAt:l()};return await T(c),c}async function U(t,s,r=50){var w;const e=(t||"").trim().toLowerCase();if(!e)return g();const o=await g(),n=Array.isArray((w=o.recent_ai_chats)==null?void 0:w[e])?o.recent_ai_chats[e]:[],c=s.map(h=>({role:h.role||"unknown",text:A(h.text||"").slice(0,4e3),capturedAt:h.capturedAt||l(),url:h.url})).filter(h=>!!h.text),a=new Set,d=[...c,...n],y=[];for(const h of d){const O=`${h.role}@@${h.text}`;if(!a.has(O)&&(a.add(O),y.push(h),y.length>=r))break}const _={...o,recent_ai_chats:{...o.recent_ai_chats,[e]:y},updatedAt:l()};return await T(_),_}function C(t,s){const o=[];o.push("Recent search queries (newest first):");for(const c of(t.recent_searches||[]).slice(0,10))o.push(`- ${c.query}${c.engine?` [${c.engine}]`:""}`);const n=Object.keys(t.recent_ai_chats||{}).sort();if(n.length){o.push(`
Recent AI chat messages (newest first):`);for(const c of n){const a=(t.recent_ai_chats[c]||[]).slice(0,12);if(a.length){o.push(`
Host: ${c}`);for(const d of a){const y=d.role||"unknown";o.push(`- ${y}: ${d.text}`)}}}}return o.join(`
`).trim()}const m="http://localhost:8000",W="ws://localhost:8000";let i=null,E=null,u=null,S=0;const $=5,F=5e3;let f="idle",p=null;async function x(){try{const t=await chrome.identity.getAuthToken({interactive:!0}),s=typeof t=="string"?t:t==null?void 0:t.token;return s?(await chrome.storage.local.set({googleToken:s,tokenTimestamp:Date.now()}),console.log("[cue] Google token stored in chrome.storage.local"),{success:!0,token:s}):{success:!1,error:"No token returned"}}catch(t){return console.error("[cue] Google login failed:",t),{success:!1,error:(t==null?void 0:t.message)||"Login failed"}}}async function j(){chrome.identity.clearAllCachedAuthTokens(),await chrome.storage.local.remove(["googleToken","tokenTimestamp"]),console.log("[cue] Google logout: tokens cleared")}async function H(){return!!(await chrome.storage.local.get(["googleToken"])).googleToken}async function b(){try{const t=await chrome.identity.getAuthToken({interactive:!1}),s=typeof t=="string"?t:t==null?void 0:t.token;return s?(await chrome.storage.local.set({googleToken:s,tokenTimestamp:Date.now()}),console.log("[cue] Fresh token obtained"),s):(console.log("[cue] No cached token, attempting interactive login"),(await x()).token||null)}catch(t){return console.error("[cue] Failed to get fresh token:",t),null}}function M(t){try{const r=new URL(t).hostname.toLowerCase();return r.includes("google.")?"Google":r.includes("bing.")?"Bing":r.includes("duckduckgo.")?"DuckDuckGo":r.includes("yahoo.")?"Yahoo":r.includes("ecosia.")?"Ecosia":void 0}catch{return}}function N(t){var s,r,e,o;try{const n=new URL(t),c=n.hostname.toLowerCase(),a=n.searchParams.get("q")||n.searchParams.get("query")||n.searchParams.get("p")||n.searchParams.get("text");return a&&a.trim()?a.trim():c.includes("google.")?((s=n.searchParams.get("q"))==null?void 0:s.trim())??null:c.includes("bing.")?((r=n.searchParams.get("q"))==null?void 0:r.trim())??null:c.includes("duckduckgo.")?((e=n.searchParams.get("q"))==null?void 0:e.trim())??null:c.includes("yahoo.")?((o=n.searchParams.get("p"))==null?void 0:o.trim())??null:null}catch{return null}}async function J(){const s=await new Promise(o=>{chrome.history.search({text:"",maxResults:200,startTime:0},o)}),r=[],e=new Set;for(const o of s){if(!o.url)continue;const n=N(o.url);if(!n)continue;const c=`${n}@@${o.url}`;if(!e.has(c)&&(e.add(c),r.push({query:n,url:o.url,engine:M(o.url),visitedAt:o.lastVisitTime??Date.now()}),r.length>=50))break}return L(r,50)}chrome.history.onVisited.addListener(async t=>{if(!t.url)return;const s=N(t.url);s&&await G({query:s,url:t.url,engine:M(t.url),visitedAt:t.lastVisitTime??Date.now()})});function V(t){return new Promise((s,r)=>{const e=new FileReader;e.onerror=()=>r(new Error("Failed to read blob")),e.onloadend=()=>{const n=e.result.split(",")[1]||"";s(n)},e.readAsDataURL(t)})}async function R(t){if(f!=="idle"){console.warn("[cue] Session already in progress");return}p=t,f="recording",console.log("[cue] Session recording started for:",t.title)}function B(){f==="recording"&&(f="paused",console.log("[cue] Session paused"))}function X(){f==="paused"&&(f="recording",console.log("[cue] Session resumed"))}async function z(t){try{console.log("[cue] Saving session, audio size:",t.audio_base64.length,"base64 chars");const s=await fetch(`${m}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,source_url:t.url,duration_seconds:t.duration,audio_base64:t.audio_base64,mime_type:t.mime_type})});if(!s.ok){let e=`HTTP ${s.status}: ${s.statusText}`;try{const o=await s.text();if(o)try{const n=JSON.parse(o);e=n.error||n.detail||e}catch{e=o.substring(0,200)}}catch(o){console.error("[cue] Failed to read error response:",o)}console.error("[cue] Backend error:",e),f="idle",p=null;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let r;try{const e=await s.text();if(!e)throw new Error("Empty response from server");r=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await s.text()),f="idle",p=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}p&&(p=null,f="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:r},o=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",r.sessionId),{success:!0,sessionId:r.sessionId}}catch(s){return console.error("[cue] Failed to save session:",s),f="idle",p=null,{success:!1,error:s.message||"Unknown error occurred"}}}function I(){return new Promise((t,s)=>{if((u==null?void 0:u.readyState)===WebSocket.OPEN){t(u);return}const r=new WebSocket(`${W}/ws/puppeteer`);r.onopen=()=>{console.log("Puppeteer WebSocket connected"),S=0,u=r,t(r)},r.onerror=e=>{console.error("Puppeteer WebSocket error:",e),s(e)},r.onclose=()=>{console.log("Puppeteer WebSocket closed"),u=null,i&&i.state==="recording"&&S<$&&(S++,setTimeout(()=>I().catch(console.error),1e3*S))},r.onmessage=async e=>{try{const o=JSON.parse(e.data),[n]=await chrome.tabs.query({active:!0,currentWindow:!0});n!=null&&n.id&&(o.type==="pose"?chrome.tabs.sendMessage(n.id,{type:"POSE_UPDATE",payload:o}):o.type==="diagram"?chrome.tabs.sendMessage(n.id,{type:"DIAGRAM_RECEIVED",payload:o}):o.type==="motion"&&chrome.tabs.sendMessage(n.id,{type:"MOTION_DETECTED",payload:o}))}catch(o){console.error("Failed to parse WebSocket message:",o)}}})}async function K(t,s){try{const r=await V(t);await D(r,s)}catch(r){console.error("Failed to send audio chunk:",r)}}async function D(t,s){try{(u==null?void 0:u.readyState)===WebSocket.OPEN?u.send(JSON.stringify({type:"audio_chunk",audio_base64:t,mime_type:s,timestamp:Date.now()})):await Y(t,s)}catch(r){console.error("Failed to send audio chunk:",r)}}async function Y(t,s){const e=await(await fetch(`${m}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:t,mime_type:s})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o!=null&&o.id){const n=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(o.id,{type:n,payload:e})}}}async function Q(){try{await I()}catch(s){console.warn("Could not establish WebSocket, will use HTTP fallback:",s)}const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id))throw new Error("No active tab");try{const s=await new Promise((r,e)=>{chrome.tabCapture.getMediaStreamId({targetTabId:t.id},o=>{var n;chrome.runtime.lastError?e(new Error(((n=chrome.runtime.lastError)==null?void 0:n.message)||"getMediaStreamId failed")):r(o)})});await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Tab audio capture for Go Live"}),await new Promise((r,e)=>{setTimeout(()=>{chrome.runtime.sendMessage({target:"offscreen",type:"START_CAPTURE",streamId:s,includeMic:!1},o=>{var n;chrome.runtime.lastError?e(new Error((n=chrome.runtime.lastError)==null?void 0:n.message)):o!=null&&o.success?r():e(new Error((o==null?void 0:o.error)||"START_CAPTURE failed"))})},150)}),chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STARTED"});return}catch(s){console.warn("[cue] Offscreen capture failed, falling back to tabCapture.capture:",s)}return new Promise((s,r)=>{chrome.tabCapture.capture({audio:!0,video:!1},e=>{var n;if(chrome.runtime.lastError||!e){r(new Error(((n=chrome.runtime.lastError)==null?void 0:n.message)||"Failed to start tab capture"));return}E=e;const o={mimeType:"audio/webm;codecs=opus"};try{i=new MediaRecorder(e,o)}catch{i=new MediaRecorder(e)}i.ondataavailable=c=>{c.data&&c.data.size>0&&K(c.data,(i==null?void 0:i.mimeType)||"audio/webm")},i.start(F),chrome.tabs.query({active:!0,currentWindow:!0}).then(([c])=>{c!=null&&c.id&&chrome.tabs.sendMessage(c.id,{type:"GO_LIVE_STARTED"})}),s()})})}async function Z(){i&&i.state!=="inactive"&&i.stop(),E&&(E.getTracks().forEach(t=>t.stop()),E=null),i=null;try{await chrome.offscreen.hasDocument()&&chrome.runtime.sendMessage({target:"offscreen",type:"STOP_CAPTURE"},()=>{chrome.offscreen.closeDocument()})}catch{}u&&(u.close(),u=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((t,s,r)=>{if(t.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:t.url||"http://localhost:3001"}),r({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),r({success:!1,error:e.message})}return!0}if(t.type==="CONTEXT_GET_SNAPSHOT")return g().then(e=>r({success:!0,snapshot:e})).catch(e=>r({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_REFRESH_SEARCHES")return J().then(e=>r({success:!0,snapshot:e})).catch(e=>r({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_CLEAR")return q().then(()=>r({success:!0})).catch(e=>r({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_SAVE_CHAT_MESSAGES"){const{hostname:e,url:o,messages:n}=t.payload||{};return!e||!Array.isArray(n)?(r({success:!1,error:"Missing hostname or messages"}),!0):(U(e,n.map(c=>({role:c.role||"unknown",text:c.text,url:o}))).then(()=>r({success:!0})).catch(c=>r({success:!1,error:String(c)})),!0)}if(t.type==="CONTEXT_SUGGEST")return(async()=>{try{const e=await g(),o=C(e);if(!o.trim()){r({success:!1,error:"No context to suggest from"});return}const c=await(await fetch(`${m}/suggest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context_blob:o})})).json();c.success&&c.answer?r({success:!0,suggestion:c.answer}):r({success:!1,error:c.error||"Suggest failed"})}catch(e){r({success:!1,error:(e==null?void 0:e.message)||"Suggest failed"})}})(),!0;if(t.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=t.query||"",n=o.match(/^@(gmail|calendar|tasks|docs|drive|sheets)\s+(.+)/i);if(n){const c=n[1].toLowerCase(),a=n[2],d=t.confirm?await b():(await chrome.storage.local.get(["googleToken"])).googleToken||"",w={...await(await fetch(`${m}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:c,command:a,user_token:d,confirm:t.confirm||!1,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json(),type:"command",service:c,original_query:o};r(w),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_RESULT",payload:w})}else{let c="";if(t.includeContext){const _=await g();c=C(_)}const a={query:o,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??"",context_blob:c||void 0},y=await(await fetch(`${m}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();r(y),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:y})}}catch(e){r({success:!1,error:e.message})}})(),!0;if(t.type==="EXECUTE_COMMAND")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=await b();if(!o){r({success:!1,error:"Please sign in with Google first.",requires_auth:!0}),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:{success:!1,error:"Please sign in with Google first."}});return}const c=await(await fetch(`${m}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:t.service,command:t.command,user_token:o,confirm:!0,page_title:(e==null?void 0:e.title)??t.pageTitle??"",current_url:(e==null?void 0:e.url)??t.currentUrl??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json();r(c),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:c})}catch(e){r({success:!1,error:e.message})}})(),!0;if(t.type==="PRISM_SUMMARIZE")return fetch(`${m}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then(e=>e.json()).then(async e=>{r({status:"ok",data:e});const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_START")return R(t.payload).then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_PAUSE"){B(),r({status:"ok"});return}if(t.type==="SESSION_RESUME"){X(),r({status:"ok"});return}if(t.type==="SESSION_STOP")return z(t.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;if(t.type==="GO_LIVE_START")return Q().then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="GO_LIVE_STOP"){Z(),r({status:"ok"});return}if(t.type==="AUDIO_CHUNK")return D(t.chunk,t.mimeType||"audio/webm").then(()=>r({ok:!0})),!0;if(t.type==="GOOGLE_LOGIN")return x().then(e=>r(e)).catch(e=>r({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="GOOGLE_LOGOUT")return j().then(()=>r({success:!0})).catch(e=>r({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="CHECK_LOGIN")return H().then(e=>r({loggedIn:e})).catch(()=>r({loggedIn:!1})),!0});
