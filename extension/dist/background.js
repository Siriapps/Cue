const p="http://localhost:8000",S="ws://localhost:8000";let a=null,d=null,c=null,l=0;const f=5,m=5e3;let i="idle",u=null;function E(r){return new Promise((n,t)=>{const e=new FileReader;e.onerror=()=>t(new Error("Failed to read blob")),e.onloadend=()=>{const s=e.result.split(",")[1]||"";n(s)},e.readAsDataURL(r)})}async function _(r){if(i!=="idle"){console.warn("[cue] Session already in progress");return}u=r,i="recording",console.log("[cue] Session recording started for:",r.title)}function w(){i==="recording"&&(i="paused",console.log("[cue] Session paused"))}function g(){i==="paused"&&(i="recording",console.log("[cue] Session resumed"))}async function T(r){try{console.log("[cue] Saving session, audio size:",r.audio_base64.length,"base64 chars");const n=await fetch(`${p}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:r.title,source_url:r.url,duration_seconds:r.duration,audio_base64:r.audio_base64,mime_type:r.mime_type})});if(!n.ok){let e=`HTTP ${n.status}: ${n.statusText}`;try{const o=await n.text();if(o)try{const s=JSON.parse(o);e=s.error||s.detail||e}catch{e=o.substring(0,200)}}catch(o){console.error("[cue] Failed to read error response:",o)}console.error("[cue] Backend error:",e),i="idle",u=null;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let t;try{const e=await n.text();if(!e)throw new Error("Empty response from server");t=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await n.text()),i="idle",u=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}u&&(u=null,i="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:t},o=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",t.sessionId),{success:!0,sessionId:t.sessionId}}catch(n){return console.error("[cue] Failed to save session:",n),i="idle",u=null,{success:!1,error:n.message||"Unknown error occurred"}}}function h(){return new Promise((r,n)=>{if((c==null?void 0:c.readyState)===WebSocket.OPEN){r(c);return}const t=new WebSocket(`${S}/ws/puppeteer`);t.onopen=()=>{console.log("Puppeteer WebSocket connected"),l=0,c=t,r(t)},t.onerror=e=>{console.error("Puppeteer WebSocket error:",e),n(e)},t.onclose=()=>{console.log("Puppeteer WebSocket closed"),c=null,a&&a.state==="recording"&&l<f&&(l++,setTimeout(()=>h().catch(console.error),1e3*l))},t.onmessage=async e=>{try{const o=JSON.parse(e.data),[s]=await chrome.tabs.query({active:!0,currentWindow:!0});s!=null&&s.id&&(o.type==="pose"?chrome.tabs.sendMessage(s.id,{type:"POSE_UPDATE",payload:o}):o.type==="diagram"?chrome.tabs.sendMessage(s.id,{type:"DIAGRAM_RECEIVED",payload:o}):o.type==="motion"&&chrome.tabs.sendMessage(s.id,{type:"MOTION_DETECTED",payload:o}))}catch(o){console.error("Failed to parse WebSocket message:",o)}}})}async function O(r,n){try{const t=await E(r);(c==null?void 0:c.readyState)===WebSocket.OPEN?c.send(JSON.stringify({type:"audio_chunk",audio_base64:t,mime_type:n,timestamp:Date.now()})):await b(t,n)}catch(t){console.error("Failed to send audio chunk:",t)}}async function b(r,n){const e=await(await fetch(`${p}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:r,mime_type:n})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o!=null&&o.id){const s=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(o.id,{type:s,payload:e})}}}async function P(){try{await h()}catch(r){console.warn("Could not establish WebSocket, will use HTTP fallback:",r)}return new Promise((r,n)=>{chrome.tabCapture.capture({audio:!0,video:!1},t=>{var o;if(chrome.runtime.lastError||!t){n(new Error(((o=chrome.runtime.lastError)==null?void 0:o.message)||"Failed to start tab capture"));return}d=t;const e={mimeType:"audio/webm;codecs=opus"};try{a=new MediaRecorder(t,e)}catch{a=new MediaRecorder(t)}a.ondataavailable=s=>{s.data&&s.data.size>0&&O(s.data,(a==null?void 0:a.mimeType)||"audio/webm")},a.start(m),chrome.tabs.query({active:!0,currentWindow:!0}).then(([s])=>{s!=null&&s.id&&chrome.tabs.sendMessage(s.id,{type:"GO_LIVE_STARTED"})}),r()})})}function I(){a&&a.state!=="inactive"&&a.stop(),d&&(d.getTracks().forEach(r=>r.stop()),d=null),a=null,c&&(c.close(),c=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([r])=>{r!=null&&r.id&&chrome.tabs.sendMessage(r.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((r,n,t)=>{if(r.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:r.url||"http://localhost:3001"}),t({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),t({success:!1,error:e.message})}return!0}if(r.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),o={query:r.query,page_title:(e==null?void 0:e.title)||"",current_url:(e==null?void 0:e.url)||"",selected_text:r.selectedText||""},y=await(await fetch(`${p}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json();t(y),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:y})}catch(e){t({success:!1,error:e.message})}})(),!0;if(r.type==="PRISM_SUMMARIZE")return fetch(`${p}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.payload)}).then(e=>e.json()).then(async e=>{t({status:"ok",data:e});const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>t({status:"error",error:e.message})),!0;if(r.type==="SESSION_START")return _(r.payload).then(()=>t({status:"ok"})).catch(e=>t({status:"error",error:e.message})),!0;if(r.type==="SESSION_PAUSE"){w(),t({status:"ok"});return}if(r.type==="SESSION_RESUME"){g(),t({status:"ok"});return}if(r.type==="SESSION_STOP")return T(r.payload).then(e=>t(e)).catch(e=>t({success:!1,error:e.message})),!0;if(r.type==="GO_LIVE_START")return P().then(()=>t({status:"ok"})).catch(e=>t({status:"error",error:e.message})),!0;if(r.type==="GO_LIVE_STOP"){I(),t({status:"ok"});return}});
