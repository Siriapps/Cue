const Y="cue_context_v1";function S(){return Date.now()}function ee(t){return t.replace(/\s+/g," ").trim()}function ae(t,s){return t.slice(0,s)}function ie(){var t;try{return((t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)||null}catch{return null}}async function k(){const t=ie();return t?new Promise(s=>{t.get([Y],o=>{const e=o==null?void 0:o[Y];if(!e||typeof e!="object"){s({recent_searches:[],recent_ai_chats:{},recent_sites:[],updatedAt:S()});return}s({recent_searches:Array.isArray(e.recent_searches)?e.recent_searches:[],recent_ai_chats:e.recent_ai_chats&&typeof e.recent_ai_chats=="object"?e.recent_ai_chats:{},recent_sites:Array.isArray(e.recent_sites)?e.recent_sites:[],updatedAt:typeof e.updatedAt=="number"?e.updatedAt:S()})})}):{recent_searches:[],recent_ai_chats:{},recent_sites:[],updatedAt:S()}}async function j(t){const s=ie();if(s)return new Promise(o=>{s.set({[Y]:{...t,updatedAt:S()}},()=>o())})}async function Se(){await j({recent_searches:[],recent_ai_chats:{},recent_sites:[],updatedAt:S()})}async function we(t,s=50){const o=await k(),e=ee(t.query);if(!e)return o;const r={...t,query:e,visitedAt:t.visitedAt||S()},c=o.recent_searches.filter(n=>!(n.query===r.query&&n.url===r.url)),a={...o,recent_searches:ae([r,...c],s),updatedAt:S()};return await j(a),a}async function Ee(t,s=50){const o=await k(),e=t.map(n=>({query:ee(n.query||""),url:n.url,engine:n.engine,visitedAt:n.visitedAt||S()})).filter(n=>!!n.query&&!!n.url),r=new Set,c=[];for(const n of e){const i=`${n.query}@@${n.url}`;if(!r.has(i)&&(r.add(i),c.push(n),c.length>=s))break}const a={...o,recent_searches:c,updatedAt:S()};return await j(a),a}async function ke(t,s,o=50){var d;const e=(t||"").trim().toLowerCase();if(!e)return k();const r=await k(),c=Array.isArray((d=r.recent_ai_chats)==null?void 0:d[e])?r.recent_ai_chats[e]:[],a=s.map(u=>({role:u.role||"unknown",text:ee(u.text||"").slice(0,4e3),capturedAt:u.capturedAt||S(),url:u.url})).filter(u=>!!u.text),n=new Set,i=[...a,...c],l=[];for(const u of i){const g=`${u.role}@@${u.text}`;if(!n.has(g)&&(n.add(g),l.push(u),l.length>=o))break}const f={...r,recent_ai_chats:{...r.recent_ai_chats,[e]:l},updatedAt:S()};return await j(f),f}async function Oe(t,s=30){const o=await k();if(t.durationMs<1e4||["google.com","bing.com","duckduckgo.com","yahoo.com","ecosia.org"].some(n=>t.domain.includes(n)))return o;const r={url:t.url,title:(t.title||t.domain).slice(0,200),domain:t.domain,visitedAt:t.visitedAt||S(),durationMs:t.durationMs},c=(o.recent_sites||[]).filter(n=>n.url!==r.url),a={...o,recent_sites:ae([r,...c],s),updatedAt:S()};return await j(a),a}function R(t,s){var n;const o=(s==null?void 0:s.maxSearches)??10,e=(s==null?void 0:s.maxMessagesPerHost)??12,r=(s==null?void 0:s.maxSites)??10,c=[];c.push("Recent search queries (newest first):");for(const i of(t.recent_searches||[]).slice(0,o))c.push(`- ${i.query}${i.engine?` [${i.engine}]`:""}`);if((n=t.recent_sites)!=null&&n.length){c.push(`
Recent sites visited (>10s dwell time, newest first):`);for(const i of t.recent_sites.slice(0,r)){const l=Math.round(i.durationMs/1e3);c.push(`- ${i.title||i.domain} (${l}s)`)}}const a=Object.keys(t.recent_ai_chats||{}).sort();if(a.length){c.push(`
Recent AI chat messages (newest first):`);for(const i of a){const l=(t.recent_ai_chats[i]||[]).slice(0,e);if(l.length){c.push(`
Host: ${i}`);for(const f of l){const d=f.role||"unknown";c.push(`- ${d}: ${f.text}`)}}}}return c.join(`
`).trim()}const p="http://localhost:8000",ue="ws://localhost:8000";let _=null,K=null,T=null,q=0;const Ae=5,Ce=5e3;let O="idle",x=null;async function le(){try{const t=await chrome.identity.getAuthToken({interactive:!0}),s=typeof t=="string"?t:t==null?void 0:t.token;return s?(await chrome.storage.local.set({googleToken:s,tokenTimestamp:Date.now()}),console.log("[cue] Google token stored in chrome.storage.local"),{success:!0,token:s}):{success:!1,error:"No token returned"}}catch(t){return console.error("[cue] Google login failed:",t),{success:!1,error:(t==null?void 0:t.message)||"Login failed"}}}async function be(){chrome.identity.clearAllCachedAuthTokens(),await chrome.storage.local.remove(["googleToken","tokenTimestamp"]),console.log("[cue] Google logout: tokens cleared")}async function Pe(){return!!(await chrome.storage.local.get(["googleToken"])).googleToken}async function H(){try{const t=await chrome.identity.getAuthToken({interactive:!1}),s=typeof t=="string"?t:t==null?void 0:t.token;return s?(await chrome.storage.local.set({googleToken:s,tokenTimestamp:Date.now()}),console.log("[cue] Fresh token obtained"),s):(console.log("[cue] No cached token, attempting interactive login"),(await le()).token||null)}catch(t){return console.error("[cue] Failed to get fresh token:",t),null}}function de(t){try{const o=new URL(t).hostname.toLowerCase();return o.includes("google.")?"Google":o.includes("bing.")?"Bing":o.includes("duckduckgo.")?"DuckDuckGo":o.includes("yahoo.")?"Yahoo":o.includes("ecosia.")?"Ecosia":void 0}catch{return}}function ge(t){var s,o,e,r;try{const c=new URL(t),a=c.hostname.toLowerCase(),n=c.searchParams.get("q")||c.searchParams.get("query")||c.searchParams.get("p")||c.searchParams.get("text");return n&&n.trim()?n.trim():a.includes("google.")?((s=c.searchParams.get("q"))==null?void 0:s.trim())??null:a.includes("bing.")?((o=c.searchParams.get("q"))==null?void 0:o.trim())??null:a.includes("duckduckgo.")?((e=c.searchParams.get("q"))==null?void 0:e.trim())??null:a.includes("yahoo.")?((r=c.searchParams.get("p"))==null?void 0:r.trim())??null:null}catch{return null}}async function De(){const s=await new Promise(r=>{chrome.history.search({text:"",maxResults:200,startTime:0},r)}),o=[],e=new Set;for(const r of s){if(!r.url)continue;const c=ge(r.url);if(!c)continue;const a=`${c}@@${r.url}`;if(!e.has(a)&&(e.add(a),o.push({query:c,url:r.url,engine:de(r.url),visitedAt:r.lastVisitTime??Date.now()}),o.length>=50))break}return Ee(o,50)}chrome.history.onVisited.addListener(async t=>{if(!t.url)return;const s=ge(t.url);s&&(await we({query:s,url:t.url,engine:de(t.url),visitedAt:t.lastVisitTime??Date.now()}),chrome.tabs.query({active:!0,currentWindow:!0},([o])=>{o!=null&&o.id&&o.url&&o.url===t.url&&ye(o.id,o.url)}),re(t.url,"search_query"))});const X={"github.com":"coding","stackoverflow.com":"coding","leetcode.com":"coding","codepen.io":"coding","codesandbox.io":"coding","replit.com":"coding","gitlab.com":"coding","bitbucket.org":"coding","npmjs.com":"coding","pypi.org":"coding","gmail.com":"email","mail.google.com":"email","outlook.com":"email","outlook.live.com":"email","mail.yahoo.com":"email","calendar.google.com":"calendar","outlook.office.com":"calendar","docs.google.com":"docs","sheets.google.com":"docs","slides.google.com":"docs","drive.google.com":"docs","notion.so":"docs","figma.com":"docs","twitter.com":"social","x.com":"social","linkedin.com":"social","facebook.com":"social","reddit.com":"social","amazon.com":"shopping","ebay.com":"shopping","etsy.com":"shopping","youtube.com":"video","netflix.com":"video","twitch.tv":"video","chat.openai.com":"ai","gemini.google.com":"ai","claude.ai":"ai","perplexity.ai":"ai","news.ycombinator.com":"news","techcrunch.com":"news","bbc.com":"news","cnn.com":"news"};let m="active",z="",W=0,v=[],F=0;const Q=2*60*1e3,Z=5*60*1e3,ce="cue_auto_suggest_delay_ms_v1",B=6e4,te=5;let w=0;const G=50;let y=0;const D=5;let I=0,$=3e4;try{chrome.storage.local.get(["cue_suggest_frequency"],t=>{t.cue_suggest_frequency&&($=Number(t.cue_suggest_frequency)*1e3,console.log(`[cue] Suggest cooldown set to ${$}ms from settings`))}),chrome.storage.onChanged.addListener(t=>{var s;(s=t.cue_suggest_frequency)!=null&&s.newValue&&($=Number(t.cue_suggest_frequency.newValue)*1e3,console.log(`[cue] Suggest cooldown updated to ${$}ms`))})}catch{}const M={},J={},h=[],he=10;let $e=0;function Me(t,s){const o=Date.now();if(h.length>0){const e=h[h.length-1];e.durationMs=o-e.timestamp,e.durationMs>=1e4&&Oe({url:e.url,title:e.title,domain:e.domain,visitedAt:e.timestamp,durationMs:e.durationMs}).catch(()=>{})}try{const r=new URL(t).hostname.replace("www.",""),c=me(t);if(h.length>0&&h[h.length-1].url===t)return;for(h.push({url:t,title:s||r,domain:r,category:c,timestamp:o});h.length>he;)h.shift();$e=o,chrome.storage.local.set({urlTrajectory:h.slice()})}catch{}}function fe(){if(h.length===0)return"";const t=h.map((s,o)=>{const e=Math.round((Date.now()-s.timestamp)/6e4),r=s.durationMs?` (${Math.round(s.durationMs/1e3)}s)`:"";return`${o+1}. [${s.category}] ${s.title}${r} - ${e}m ago`});return`Active Browsing Trajectory (last ${h.length} pages):
${t.join(`
`)}`}function oe(){const t=[];h.forEach(o=>{t.push(o.category);const e=o.title.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(r=>r.length>3);t.push(...e.slice(0,5));try{const c=new URL(o.url).pathname.replace(/[^a-z0-9]/gi," ").toLowerCase().split(/\s+/).filter(a=>a.length>3);t.push(...c.slice(0,3))}catch{}});const s={};return t.forEach(o=>{s[o]=(s[o]||0)+1}),Object.entries(s).sort((o,e)=>e[1]-o[1]).slice(0,10).map(([o])=>o)}function ne(t,s){return s.length===0?!1:t.filter(r=>s.includes(r)).length/Math.max(t.length,s.length)>.4}chrome.storage.local.get(["urlTrajectory"],t=>{t.urlTrajectory&&Array.isArray(t.urlTrajectory)&&(h.push(...t.urlTrajectory.slice(-he)),console.log(`[cue] Loaded ${h.length} trajectory entries from storage`))});function me(t){try{const s=new URL(t).hostname.replace("www.","");if(X[s])return X[s];for(const[o,e]of Object.entries(X))if(s.includes(o)||s.endsWith("."+o))return e;return"general"}catch{return"general"}}function Ne(t,s){const o=me(t),e=Date.now(),r=oe(),c=s==="page_dwell";switch(m){case"cooldown":{if(e-W<Q){const a=Math.round((Q-(e-W))/1e3);return console.log(`[cue] State: COOLDOWN - ${a}s remaining`),!1}m="intent_check",console.log("[cue] State: COOLDOWN -> INTENT_CHECK")}case"intent_check":{if(!ne(r,v)){console.log(`[cue] PIVOT DETECTED - topic changed from [${v.slice(0,3).join(", ")}] to [${r.slice(0,3).join(", ")}]`),m="active";break}if(!c)return console.log("[cue] Same topic detected - entering LOCKOUT"),m="lockout",F=e,!1;m="active";break}case"lockout":{if(e-F<Z){if(!ne(r,v)){console.log("[cue] PIVOT in LOCKOUT - topic changed, resetting to ACTIVE"),m="active";break}if(!c){const a=Math.round((Z-(e-F))/1e3);return console.log(`[cue] State: LOCKOUT - ${a}s remaining`),!1}m="active";break}console.log("[cue] State: LOCKOUT -> ACTIVE"),m="active";break}}return c||o!==z?(console.log(`[cue] Auto-suggest: ${c?"page_dwell":"category change"} (${o})`),z=o,W=e,v=r.slice(),m="cooldown",!0):(console.log(`[cue] Auto-suggest: same category "${o}", state: ${m}`),!1)}function xe(){W=Date.now(),m="cooldown",console.log("[cue] User viewed suggestions - entering COOLDOWN")}function re(t,s){Ne(t,s)&&(console.log(`[cue] Triggering auto-suggest (${s})`),Ie(s))}function ve(){return new Promise(t=>{var s;try{if(!((s=chrome==null?void 0:chrome.storage)!=null&&s.local))return t(B);chrome.storage.local.get([ce],o=>{const e=o==null?void 0:o[ce],r=typeof e=="number"&&e>=5e3?e:B;t(Math.min(r,5*60*1e3))})}catch{t(B)}})}function ye(t,s){M[t]&&clearTimeout(M[t]),J[t]=s,ve().then(o=>{J[t]===s&&(M[t]=setTimeout(()=>{J[t]===s&&re(s,"page_dwell"),delete M[t]},o))})}chrome.tabs.onUpdated.addListener((t,s,o)=>{s.status==="complete"&&o.url&&!o.url.startsWith("chrome://")&&(Me(o.url,o.title||""),ye(t,o.url),re(o.url,"context_change"))});chrome.tabs.onRemoved.addListener(t=>{M[t]&&(clearTimeout(M[t]),delete M[t]),delete J[t]});async function Ie(t){const s=Date.now();if(s-I<$){console.log(`[cue] Skipping auto-suggest (${t}): global cooldown (${Math.round(($-(s-I))/1e3)}s left)`);return}if(y>=D){console.log("[cue] Skipping auto-suggest: user has pending tasks to review");return}if(w>=G){console.log("[cue] Session task limit reached (50). Accept a task to generate more.");return}I=s;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0}),e=await k();let r=R(e);const c=fe();c&&(r=`${r}

${c}`),r.trim()||(console.log("[cue] Context empty, using current page only"),r=`Currently browsing: ${(o==null?void 0:o.title)||"Unknown page"}
URL: ${(o==null?void 0:o.url)||""}`),console.log(`[cue] Auto-suggest triggered by: ${t}`),console.log(`[cue] State machine: ${m}, trajectory: ${h.length} entries`);const n=await(await fetch(`${p}/suggest_tasks`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context_blob:r,page_title:(o==null?void 0:o.title)||"",current_url:(o==null?void 0:o.url)||"",trajectory:h.slice()})})).json();if(n.success&&n.tasks&&n.tasks.length>0){const i=n.tasks.slice(0,te);console.log(`[cue] Auto-suggest returned ${i.length} tasks (capped from ${n.tasks.length}):`,i.map(l=>l.title)),w+=i.length,y=Math.min(D,y+i.length),console.log(`[cue] Session task count: ${w}/${G}, active: ${y}/${D}`),v=oe(),o!=null&&o.id?(console.log(`[cue] Sending PREDICTED_TASKS_POPUP to tab ${o.id}`),chrome.tabs.sendMessage(o.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:i,trigger:t}}).then(()=>{console.log("[cue] PREDICTED_TASKS_POPUP sent successfully")}).catch(l=>{console.error("[cue] Failed to send PREDICTED_TASKS_POPUP:",l),chrome.tabs.query({},f=>{f.forEach(d=>{d.id&&d.url&&!d.url.startsWith("chrome://")&&chrome.tabs.sendMessage(d.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:i,trigger:t}}).catch(()=>{})})})})):console.log("[cue] No active tab id to send popup to")}else console.log("[cue] Auto-suggest returned no tasks or failed:",n.error||"empty")}catch(o){console.error("[cue] Auto-suggest error:",o)}}function Ue(t){return new Promise((s,o)=>{const e=new FileReader;e.onerror=()=>o(new Error("Failed to read blob")),e.onloadend=()=>{const c=e.result.split(",")[1]||"";s(c)},e.readAsDataURL(t)})}let U=null;async function We(t){const s=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[t]});if(s.length>0)try{fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:48",message:"Closing existing offscreen document",data:{documentId:s[0].documentId},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),await chrome.offscreen.closeDocument({documentId:s[0].documentId}),fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:52",message:"Offscreen document closed successfully",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),await new Promise(o=>setTimeout(o,200))}catch(o){fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:57",message:"Error closing offscreen document",data:{error:String(o)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})}if(U)await U;else{U=(async()=>{try{fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:62",message:"Creating new offscreen document",data:{path:t},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),await chrome.offscreen.createDocument({url:t,reasons:["USER_MEDIA"],justification:"Wake word detection and audio capture from tab"}),fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:70",message:"Offscreen document created successfully",data:{path:t},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})}catch(o){if(fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:73",message:"Error creating offscreen document",data:{error:o.message},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),!o.message.startsWith("Only a single offscreen"))throw console.error("[cue] Failed to create offscreen document:",o),o}})();try{await U}finally{U=null}}}async function Ge(t){if(O!=="idle"){console.warn("[cue] Session already in progress");return}x=t,O="recording",console.log("[cue] Session recording started for:",t.title)}function je(){O==="recording"&&(O="paused",console.log("[cue] Session paused"))}function Le(){O==="paused"&&(O="recording",console.log("[cue] Session resumed"))}async function qe(t){try{console.log("[cue] Saving session, audio size:",t.audio_base64.length,"base64 chars");const s=await fetch(`${p}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,source_url:t.url,duration_seconds:t.duration,audio_base64:t.audio_base64,mime_type:t.mime_type})});if(!s.ok){let e=`HTTP ${s.status}: ${s.statusText}`;try{const r=await s.text();if(r)try{const c=JSON.parse(r);e=c.error||c.detail||e}catch{e=r.substring(0,200)}}catch(r){console.error("[cue] Failed to read error response:",r)}console.error("[cue] Backend error:",e),O="idle",x=null;try{const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});r!=null&&r.id&&chrome.tabs.sendMessage(r.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let o;try{const e=await s.text();if(!e)throw new Error("Empty response from server");o=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await s.text()),O="idle",x=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}x&&(x=null,O="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:o},r=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",o.sessionId),{success:!0,sessionId:o.sessionId}}catch(s){return console.error("[cue] Failed to save session:",s),O="idle",x=null,{success:!1,error:s.message||"Unknown error occurred"}}}function pe(){return new Promise((t,s)=>{if((T==null?void 0:T.readyState)===WebSocket.OPEN){t(T);return}const o=new WebSocket(`${ue}/ws/puppeteer`);o.onopen=()=>{console.log("Puppeteer WebSocket connected"),q=0,T=o,t(o)},o.onerror=e=>{console.error("Puppeteer WebSocket error:",e),s(e)},o.onclose=()=>{console.log("Puppeteer WebSocket closed"),T=null,_&&_.state==="recording"&&q<Ae&&(q++,setTimeout(()=>pe().catch(console.error),1e3*q))},o.onmessage=async e=>{try{const r=JSON.parse(e.data),[c]=await chrome.tabs.query({active:!0,currentWindow:!0});c!=null&&c.id&&(r.type==="pose"?chrome.tabs.sendMessage(c.id,{type:"POSE_UPDATE",payload:r}):r.type==="diagram"?chrome.tabs.sendMessage(c.id,{type:"DIAGRAM_RECEIVED",payload:r}):r.type==="motion"&&chrome.tabs.sendMessage(c.id,{type:"MOTION_DETECTED",payload:r}))}catch(r){console.error("Failed to parse WebSocket message:",r)}}})}async function Re(t,s){try{const o=await Ue(t);await _e(o,s)}catch(o){console.error("Failed to send audio chunk:",o)}}async function _e(t,s){try{(T==null?void 0:T.readyState)===WebSocket.OPEN?T.send(JSON.stringify({type:"audio_chunk",audio_base64:t,mime_type:s,timestamp:Date.now()})):await Ke(t,s)}catch(o){console.error("Failed to send audio chunk:",o)}}async function Ke(t,s){const e=await(await fetch(`${p}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:t,mime_type:s})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(r!=null&&r.id){const c=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(r.id,{type:c,payload:e})}}}async function Fe(){try{await pe()}catch(s){console.warn("Could not establish WebSocket, will use HTTP fallback:",s)}const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id))throw new Error("No active tab");try{const s=await new Promise((o,e)=>{chrome.tabCapture.getMediaStreamId({targetTabId:t.id},r=>{var c;chrome.runtime.lastError?e(new Error(((c=chrome.runtime.lastError)==null?void 0:c.message)||"getMediaStreamId failed")):o(r)})});await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Tab audio capture for Go Live"}),await new Promise((o,e)=>{setTimeout(()=>{chrome.runtime.sendMessage({target:"offscreen",type:"START_CAPTURE",streamId:s,includeMic:!1},r=>{var c;chrome.runtime.lastError?e(new Error((c=chrome.runtime.lastError)==null?void 0:c.message)):r!=null&&r.success?o():e(new Error((r==null?void 0:r.error)||"START_CAPTURE failed"))})},150)}),chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STARTED"});return}catch(s){console.warn("[cue] Offscreen capture failed, falling back to tabCapture.capture:",s)}return new Promise((s,o)=>{chrome.tabCapture.capture({audio:!0,video:!1},e=>{var c;if(chrome.runtime.lastError||!e){o(new Error(((c=chrome.runtime.lastError)==null?void 0:c.message)||"Failed to start tab capture"));return}K=e;const r={mimeType:"audio/webm;codecs=opus"};try{_=new MediaRecorder(e,r)}catch{_=new MediaRecorder(e)}_.ondataavailable=a=>{a.data&&a.data.size>0&&Re(a.data,(_==null?void 0:_.mimeType)||"audio/webm")},_.start(Ce),chrome.tabs.query({active:!0,currentWindow:!0}).then(([a])=>{a!=null&&a.id&&chrome.tabs.sendMessage(a.id,{type:"GO_LIVE_STARTED"})}),s()})})}async function Je(){_&&_.state!=="inactive"&&_.stop(),K&&(K.getTracks().forEach(t=>t.stop()),K=null),_=null;try{await chrome.offscreen.hasDocument()&&chrome.runtime.sendMessage({target:"offscreen",type:"STOP_CAPTURE"},()=>{chrome.offscreen.closeDocument()})}catch{}T&&(T.close(),T=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((t,s,o)=>{if(t.type==="OFFSCREEN_LOG"){(t.level==="error"?console.error:t.level==="warn"?console.warn:console.log)(t.message);return}if(t.type==="START_WAKE_WORD")return console.log("[cue background] START_WAKE_WORD received, setting up offscreen document..."),We("offscreen.html").then(()=>{console.log("[cue background] Offscreen document ready, sending START_WAKE_WORD message..."),setTimeout(()=>{console.log("[cue background] Sending message to offscreen document..."),chrome.runtime.sendMessage({type:"START_WAKE_WORD",target:"offscreen"},e=>{if(console.log("[cue background] Response from offscreen:",e),chrome.runtime.lastError){console.error("[cue background] Error sending to offscreen:",chrome.runtime.lastError.message),o({success:!1,error:chrome.runtime.lastError.message});return}if(!e){console.error("[cue background] No response from offscreen document!"),o({success:!1,error:"No response from offscreen - document may not be loaded"});return}if(e&&!e.success){const r=e.error||"";console.error("[cue background] Offscreen returned error:",r),(r==="PERMISSION_DENIED"||r.includes("permission")||r.includes("not-allowed")||r.includes("Permission denied")||r.includes("not found")||r.includes("device")||r.includes("NotFoundError"))&&(console.warn("[cue] Wake word permission/device issue. Opening permission page."),chrome.tabs.create({url:chrome.runtime.getURL("permission.html")}))}else console.log("[cue background] Wake word detection started successfully!");o(e||{success:!1,error:"No response from offscreen"})})},500)}).catch(e=>{console.error("[cue background] Failed to setup offscreen document:",e),o({success:!1,error:e.message})}),!0;if(t.type==="STOP_WAKE_WORD"){chrome.runtime.sendMessage({type:"STOP_WAKE_WORD",target:"offscreen"}),o({success:!0});return}if(t.type==="WAKE_WORD_DETECTED"){chrome.tabs.query({active:!0,currentWindow:!0}).then(([e])=>{e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"WAKE_WORD_DETECTED"})});return}if(t.type==="CHECK_ACTIVE_TAB")return chrome.tabs.query({active:!0,currentWindow:!0}).then(([e])=>{chrome.tabs.getCurrent().then(r=>{o({isActive:(e==null?void 0:e.id)===(r==null?void 0:r.id)})}).catch(()=>{t.tabId?o({isActive:(e==null?void 0:e.id)===t.tabId}):o({isActive:!1})})}),!0;if(t.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:t.url||"http://localhost:3001"}),o({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),o({success:!1,error:e.message})}return!0}if(t.type==="CONTEXT_GET_SNAPSHOT")return k().then(e=>o({success:!0,snapshot:e})).catch(e=>o({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_REFRESH_SEARCHES")return De().then(e=>o({success:!0,snapshot:e})).catch(e=>o({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_CLEAR")return Se().then(()=>o({success:!0})).catch(e=>o({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_SAVE_CHAT_MESSAGES"){const{hostname:e,url:r,messages:c}=t.payload||{};return!e||!Array.isArray(c)?(o({success:!1,error:"Missing hostname or messages"}),!0):(ke(e,c.map(a=>({role:a.role||"unknown",text:a.text,url:r}))).then(()=>o({success:!0})).catch(a=>o({success:!1,error:String(a)})),!0)}if(t.type==="CONTEXT_SUGGEST")return(async()=>{try{const e=Date.now();if(e-I<$){console.log(`[cue] CONTEXT_SUGGEST: skipped (global cooldown, ${Math.round(($-(e-I))/1e3)}s left)`),o({success:!1,error:"Recently suggested. Try again shortly."});return}if(y>=D){console.log("[cue] CONTEXT_SUGGEST: skipped (user has pending tasks)"),o({success:!1,error:"You have pending tasks to review first."});return}if(w>=G){o({success:!1,error:"Session task limit reached."});return}I=e;const[r]=await chrome.tabs.query({active:!0,currentWindow:!0}),c=await k(),a=R(c),n=(r==null?void 0:r.title)??"",i=(r==null?void 0:r.url)??"";if(!a.trim()&&!n&&!i){o({success:!1,error:"No context to suggest from"});return}let l=a.trim()||`Currently viewing: ${n}
${i}`;const f=fe();f&&(l=`${l}

${f}`);const u=await(await fetch(`${p}/suggest_tasks`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context_blob:l,page_title:n,current_url:i,trajectory:h.slice()})})).json();if(u.success&&u.tasks&&u.tasks.length>0){const g=u.tasks.slice(0,te);w+=g.length,y=Math.min(D,y+g.length),console.log(`[cue] CONTEXT_SUGGEST returned ${g.length} tasks. Session: ${w}, active: ${y}`);const C=g.length,V=C===1?g[0].title||"1 task":`${C} tasks`;o({success:!0,suggestion:`${V} added to AI Task Automation. View in dashboard.`,tasksCount:C,tasks:g})}else o({success:!1,error:u.error||"No tasks generated. Try more context."})}catch(e){o({success:!1,error:(e==null?void 0:e.message)||"Suggest failed"})}})(),!0;if(t.type==="CONTEXT_AUTO_SUGGEST")return(async()=>{var e,r;try{const c=await k(),a=new Date;a.setHours(0,0,0,0);const n=a.getTime(),i=(c.recent_searches||[]).filter(b=>b.visitedAt>=n),l={};for(const[b,L]of Object.entries(c.recent_ai_chats||{})){const P=(L||[]).filter(Te=>Te.capturedAt>=n);P.length&&(l[b]=P)}const f={...c,recent_searches:i,recent_ai_chats:l},d=R(f,{maxSearches:50,maxMessagesPerHost:50}),u=((e=t.payload)==null?void 0:e.count)||5,g=((r=t.payload)==null?void 0:r.goal)||"",C=`Based on the user's browsing and AI chat activity today, propose ${u} helpful, concrete next-step suggestions the user can take. ${g?`Focus on: ${g}`:""}

Context:
${d}`,E=await(await fetch(`${p}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:C})})).json();o({success:E.success!==!1,answer:E.answer||E.error||"No suggestions"})}catch(c){o({success:!1,error:(c==null?void 0:c.message)||"Auto-suggest failed"})}})(),!0;if(t.type==="SAVE_AUTO_SUGGESTIONS")return(async()=>{var e,r;try{const c=((e=t.payload)==null?void 0:e.items)||[],a=((r=t.payload)==null?void 0:r.sourceQuery)||"";if(c.length===0){o({success:!1});return}const n=c.map(u=>({title:u.length>80?u.slice(0,77)+"...":u,description:u,service:null,action:null,params:null,status:"pending",source_context:{page_title:a?`Search: ${a}`:"Auto-suggestion",current_url:""}})),f=(await(await fetch(`${p}/save_auto_suggestions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tasks:n})})).json()).tasks||n.map((u,g)=>({...u,id:`auto-${Date.now()}-${g}`})),[d]=await chrome.tabs.query({active:!0,currentWindow:!0});d!=null&&d.id&&chrome.tabs.sendMessage(d.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:f.slice(0,5),trigger:"auto-suggest-dismissed"}}).catch(()=>{}),o({success:!0})}catch(c){console.error("[cue] Failed to save auto-suggestions:",c),o({success:!1,error:c==null?void 0:c.message})}})(),!0;if(t.type==="EXECUTE_SUGGESTED_TASK")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),r=await H();if(!r){o({success:!1,error:"Please sign in with Google first.",requires_auth:!0}),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"TASK_EXECUTED",payload:{success:!1,error:"Please sign in with Google first."}});return}const{service:c,action:a,params:n,taskId:i}=t;if(c==="gemini_chat"||c==="antigravity"||c==="openai_studio"){console.log(`[cue] Auto-opening ${c} with context prompt`);const u=[];n!=null&&n.prompt?u.push(n.prompt):n!=null&&n.title?u.push(n.title):n!=null&&n.description?u.push(n.description):a&&u.push(a),e!=null&&e.title&&(e!=null&&e.url)&&u.push(`

Context: I was browsing "${e.title}" (${e.url})`),n!=null&&n.context&&u.push(`

Additional context: ${n.context}`);let g=u.join("");const C=g.toLowerCase();(/\b(create|write|draft|make|start)\s+(a\s+)?(doc|document|google\s*doc)\b/.test(C)||/\b(new|open)\s+(a\s+)?(doc|document)\b/.test(C))&&(c==="gemini_chat"||c==="openai_studio")&&(g=g.trimStart(),!g.startsWith("@docs")&&!g.startsWith("@docs ")&&(g=`@docs ${g}`));let E="",b="";if(c==="gemini_chat"?(E="https://gemini.google.com/app",b="Opened Gemini - prompt copied to clipboard, paste with Ctrl+V"):c==="antigravity"?(E="antigravity://",b="Prompt copied! Open Antigravity desktop app and paste (Ctrl+V), or use the web version"):c==="openai_studio"&&(E="https://chat.openai.com/",b="Opened ChatGPT - prompt copied to clipboard, paste with Ctrl+V"),e!=null&&e.id)try{await chrome.tabs.sendMessage(e.id,{type:"COPY_TO_CLIPBOARD",payload:{text:g}}),await new Promise(P=>setTimeout(P,100))}catch(P){console.warn("[cue] Could not copy to clipboard:",P)}if(console.log(`[cue] Opening ${c} at: ${E}`),chrome.tabs.create({url:E}),i)try{await fetch(`${p}/suggested_tasks/${i}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"completed",open_url:E})}),w=Math.max(0,w-1),console.log(`[cue] Task completed. Session count: ${w}/${G}`)}catch(P){console.error("[cue] Failed to mark task as completed:",P)}const L={success:!0,message:b,open_url:E,promptCopied:!0};o(L),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"TASK_EXECUTED",payload:{...L,taskId:i}});return}let l=`${a}`;c==="gmail"&&n?l=`${a} email to ${n.to||""} subject ${n.subject||""}`:c==="docs"&&n?l=`${a} document titled ${n.title||""}`:c==="calendar"&&n?l=`${a} event ${n.title||n.summary||""}`:c==="tasks"&&n&&(l=`${a} task ${n.title||""}`);const d=await(await fetch(`${p}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:c,command:l,user_token:r,confirm:!0,suggested_params:{...n||{},_action:a},page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??""})})).json();if(d.success&&d.open_url&&(console.log(`[cue] Opening URL from task execution: ${d.open_url}`),chrome.tabs.create({url:d.open_url})),i)if(d.success)try{await fetch(`${p}/suggested_tasks/${i}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"completed",open_url:d.open_url||""})}),w=Math.max(0,w-1),console.log(`[cue] Task completed. Session count: ${w}/${G}`)}catch(u){console.error("[cue] Failed to mark task as completed:",u)}else{console.warn(`[cue] Task execution failed: ${d.error}. Moving to AI queue.`);try{await fetch(`${p}/suggested_tasks/${i}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"in_progress"})})}catch(u){console.error("[cue] Failed to move task to AI queue:",u)}}o(d),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"TASK_EXECUTED",payload:{...d,taskId:i}})}catch(e){console.error("[cue] Execute suggested task error:",e);const{taskId:r}=t;if(r)try{await fetch(`${p}/suggested_tasks/${r}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"in_progress"})})}catch{}const c={success:!1,error:e.message,taskId:r};o(c);try{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});a!=null&&a.id&&chrome.tabs.sendMessage(a.id,{type:"TASK_EXECUTED",payload:c})}catch{}}})(),!0;if(t.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),r=t.query||"",c=r.match(/^@(gmail|calendar|tasks|docs|drive|sheets)\s+(.+)/i);if(c){const a=c[1].toLowerCase(),n=c[2],i=t.confirm?await H():(await chrome.storage.local.get(["googleToken"])).googleToken||"",d={...await(await fetch(`${p}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:a,command:n,user_token:i,confirm:t.confirm||!1,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json(),type:"command",service:a,original_query:r};o(d),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_RESULT",payload:d})}else{let a="";if(t.includeContext){const f=await k();a=R(f)}const n={query:r,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??"",context_blob:a||void 0};Array.isArray(t.conversationHistory)&&t.conversationHistory.length>0&&(n.conversation_history=t.conversationHistory);const l=await(await fetch(`${p}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();o(l),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:l})}}catch(e){o({success:!1,error:e.message})}})(),!0;if(t.type==="EXECUTE_COMMAND")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),r=await H();if(!r){o({success:!1,error:"Please sign in with Google first.",requires_auth:!0}),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:{success:!1,error:"Please sign in with Google first."}});return}const c={service:t.service,command:t.command,user_token:r,confirm:!0,page_title:(e==null?void 0:e.title)??t.pageTitle??"",current_url:(e==null?void 0:e.url)??t.currentUrl??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""};t.suggested_params&&typeof t.suggested_params=="object"&&(c.suggested_params=t.suggested_params);const n=await(await fetch(`${p}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})).json();o(n),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:n})}catch(e){o({success:!1,error:e.message})}})(),!0;if(t.type==="PRISM_SUMMARIZE")return fetch(`${p}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then(e=>e.json()).then(async e=>{o({status:"ok",data:e});const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});r!=null&&r.id&&chrome.tabs.sendMessage(r.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>o({status:"error",error:e.message})),!0;if(t.type==="SESSION_START")return Ge(t.payload).then(()=>o({status:"ok"})).catch(e=>o({status:"error",error:e.message})),!0;if(t.type==="SESSION_PAUSE"){je(),o({status:"ok"});return}if(t.type==="SESSION_RESUME"){Le(),o({status:"ok"});return}if(t.type==="SESSION_STOP")return qe(t.payload).then(e=>o(e)).catch(e=>o({success:!1,error:e.message})),!0;if(t.type==="GO_LIVE_START")return Fe().then(()=>o({status:"ok"})).catch(e=>o({status:"error",error:e.message})),!0;if(t.type==="GO_LIVE_STOP"){Je(),o({status:"ok"});return}if(t.type==="AUDIO_CHUNK")return _e(t.chunk,t.mimeType||"audio/webm").then(()=>o({ok:!0})),!0;if(t.type==="PERMISSION_GRANTED")return console.log("[cue] Permission granted, retrying wake word detection..."),setTimeout(()=>{chrome.runtime.sendMessage({type:"START_WAKE_WORD",target:"offscreen"},e=>{e&&e.success?console.log("[cue] Wake word detection restarted successfully after permission grant"):console.warn("[cue] Failed to restart wake word after permission grant:",e==null?void 0:e.error)}),chrome.tabs.query({},e=>{for(const r of e)r.id&&chrome.tabs.sendMessage(r.id,{type:"PERMISSION_UPDATED"},()=>{chrome.runtime.lastError})})},500),o({success:!0}),!0;if(t.type==="GOOGLE_LOGIN")return le().then(e=>o(e)).catch(e=>o({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="GOOGLE_LOGOUT")return be().then(()=>o({success:!0})).catch(e=>o({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="CHECK_LOGIN")return Pe().then(e=>o({loggedIn:e})).catch(()=>o({loggedIn:!1})),!0;if(t.type==="USER_VIEWED_SUGGESTIONS")return xe(),o({success:!0,state:m}),!0;if(t.type==="TASK_ACTION"){const e=t.count||1;return t.action==="accepted"?(y=Math.max(0,y-e),console.log(`[cue] Task accepted. Active count: ${y}/${D}`)):t.action==="dismissed"&&(y=Math.max(0,y-e),console.log(`[cue] Task dismissed (${e}). Active count: ${y}/${D}`)),y===0&&(m="active"),o({success:!0,activeTaskCount:y}),!0}if(t.type==="GET_TRAJECTORY")return o({success:!0,trajectory:h.slice(),keywords:oe(),state:m}),!0;if(t.type==="GET_SUGGESTION_STATE"){const e=Date.now();let r=0,c=0;return m==="cooldown"?r=Math.max(0,Q-(e-W)):m==="lockout"&&(c=Math.max(0,Z-(e-F))),o({success:!0,state:m,lastCategory:z,lastKeywords:v.slice(0,5),cooldownRemaining:Math.round(r/1e3),lockoutRemaining:Math.round(c/1e3)}),!0}});let A=null,N=0;const Ve=5;function se(){if((A==null?void 0:A.readyState)!==WebSocket.OPEN)try{A=new WebSocket(`${ue}/ws/extension`),A.onopen=()=>{console.log("[cue] Task sync WebSocket connected"),N=0},A.onmessage=t=>{try{const s=JSON.parse(t.data);if(s.type==="SYNCED_TASKS"||s.type==="SUGGESTED_TASKS_UPDATE"){const o=s.tasks||[];y=Math.min(D,o.filter(e=>e.status!=="completed"&&e.status!=="dismissed").length),o.length>0&&(console.log(`[cue] Received ${o.length} synced tasks from dashboard`),chrome.storage.local.set({syncedTasks:o.slice(0,50)}),chrome.tabs.query({active:!0,currentWindow:!0},([e])=>{e!=null&&e.id&&e.url&&!e.url.startsWith("chrome://")&&chrome.tabs.sendMessage(e.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:o.slice(0,te),trigger:"sync"}}).catch(()=>{})}))}s.type==="ACTIVITY_UPDATE"&&console.log("[cue] Activity update from dashboard")}catch(s){console.error("[cue] Task sync message parse error:",s)}},A.onclose=t=>{if(A=null,t.wasClean?console.log("[cue] Task sync WebSocket closed cleanly"):N===0&&console.log("[cue] Task sync: Server not available (is Python server running?)"),N<Ve){N++;const s=Math.min(1e4*N,6e4);N===1&&console.log(`[cue] Will retry connection in ${s/1e3}s`),setTimeout(se,s)}else console.log("[cue] Task sync disabled - start server and reload extension to reconnect")},A.onerror=()=>{}}catch(t){console.error("[cue] Failed to create task sync WebSocket:",t)}}se();chrome.runtime.onStartup.addListener(()=>{console.log("[cue] Extension startup - connecting task sync"),se()});
