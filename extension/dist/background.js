const b="cue_context_v1";function y(){return Date.now()}function C(t){return t.replace(/\s+/g," ").trim()}function v(t,s){return t.slice(0,s)}function P(){var t;try{return((t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)||null}catch{return null}}async function g(){const t=P();return t?new Promise(s=>{t.get([b],r=>{const e=r==null?void 0:r[b];if(!e||typeof e!="object"){s({recent_searches:[],recent_ai_chats:{},updatedAt:y()});return}s({recent_searches:Array.isArray(e.recent_searches)?e.recent_searches:[],recent_ai_chats:e.recent_ai_chats&&typeof e.recent_ai_chats=="object"?e.recent_ai_chats:{},updatedAt:typeof e.updatedAt=="number"?e.updatedAt:y()})})}):{recent_searches:[],recent_ai_chats:{},updatedAt:y()}}async function E(t){const s=P();if(s)return new Promise(r=>{s.set({[b]:{...t,updatedAt:y()}},()=>r())})}async function M(){await E({recent_searches:[],recent_ai_chats:{},updatedAt:y()})}async function $(t,s=50){const r=await g(),e=C(t.query);if(!e)return r;const n={...t,query:e,visitedAt:t.visitedAt||y()},o=r.recent_searches.filter(a=>!(a.query===n.query&&a.url===n.url)),c={...r,recent_searches:v([n,...o],s),updatedAt:y()};return await E(c),c}async function W(t,s=50){const r=await g(),e=t.map(a=>({query:C(a.query||""),url:a.url,engine:a.engine,visitedAt:a.visitedAt||y()})).filter(a=>!!a.query&&!!a.url),n=new Set,o=[];for(const a of e){const u=`${a.query}@@${a.url}`;if(!n.has(u)&&(n.add(u),o.push(a),o.length>=s))break}const c={...r,recent_searches:o,updatedAt:y()};return await E(c),c}async function D(t,s,r=50){var T;const e=(t||"").trim().toLowerCase();if(!e)return g();const n=await g(),o=Array.isArray((T=n.recent_ai_chats)==null?void 0:T[e])?n.recent_ai_chats[e]:[],c=s.map(h=>({role:h.role||"unknown",text:C(h.text||"").slice(0,4e3),capturedAt:h.capturedAt||y(),url:h.url})).filter(h=>!!h.text),a=new Set,u=[...c,...o],i=[];for(const h of u){const k=`${h.role}@@${h.text}`;if(!a.has(k)&&(a.add(k),i.push(h),i.length>=r))break}const p={...n,recent_ai_chats:{...n.recent_ai_chats,[e]:i},updatedAt:y()};return await E(p),p}function A(t,s){const r=(s==null?void 0:s.maxSearches)??10,e=(s==null?void 0:s.maxMessagesPerHost)??12,n=[];n.push("Recent search queries (newest first):");for(const c of(t.recent_searches||[]).slice(0,r))n.push(`- ${c.query}${c.engine?` [${c.engine}]`:""}`);const o=Object.keys(t.recent_ai_chats||{}).sort();if(o.length){n.push(`
Recent AI chat messages (newest first):`);for(const c of o){const a=(t.recent_ai_chats[c]||[]).slice(0,e);if(a.length){n.push(`
Host: ${c}`);for(const u of a){const i=u.role||"unknown";n.push(`- ${i}: ${u.text}`)}}}}return n.join(`
`).trim()}const m="http://localhost:8000",G="ws://localhost:8000";let l=null,w=null,d=null,S=0;const L=5,j=5e3;let f="idle",_=null;const x="cue_context_maintenance_v1",U=7*24*60*60*1e3;function F(){const t=new Date;return t.setHours(0,0,0,0),t.getTime()}function H(t){const s=F(),r=(t.recent_searches||[]).filter(n=>(n.visitedAt||0)>=s),e={};for(const[n,o]of Object.entries(t.recent_ai_chats||{})){const c=(o||[]).filter(a=>(a.capturedAt||0)>=s);c.length&&(e[n]=c)}return{...t,recent_searches:r,recent_ai_chats:e}}async function O(){var t;try{if(!((t=chrome==null?void 0:chrome.storage)!=null&&t.local))return;const s=await new Promise(e=>{chrome.storage.local.get([x],n=>{var c;const o=(c=n==null?void 0:n[x])==null?void 0:c.lastClearedAt;e(typeof o=="number"?o:0)})}),r=Date.now();(!s||r-s>=U)&&(await M(),await new Promise(e=>{chrome.storage.local.set({[x]:{lastClearedAt:r}},()=>e())}))}catch{}}O().catch(()=>{});function R(t){const s=t.toLowerCase();return s.includes("google")?"google":s.includes("bing")?"bing":s.includes("duckduckgo")?"duckduckgo":s.includes("yahoo")?"yahoo":s.includes("brave")?"brave":s.includes("perplexity")?"perplexity":t}function q(t){try{const s=new URL(t),r=s.hostname.toLowerCase(),e=s.searchParams,o=([e.get("q"),e.get("query"),e.get("p"),e.get("text"),e.get("search")].filter(Boolean)[0]||"").trim();return!o||!(r.includes("google")||r.includes("bing")||r.includes("duckduckgo")||r.includes("yahoo")||r.includes("brave")||r.includes("perplexity")||s.pathname.includes("/search"))?null:{query:o,engine:R(r)}}catch{return null}}async function V(t=50){var n;if(!((n=chrome==null?void 0:chrome.history)!=null&&n.search))return[];const r=await new Promise(o=>{chrome.history.search({text:"",maxResults:2e3},c=>o(c||[]))}),e=[];for(const o of r){const c=o.url||"",a=q(c);if(a&&(e.push({query:a.query,engine:a.engine,url:c,visitedAt:o.lastVisitTime||Date.now()}),e.length>=t))break}return e}var N;try{(N=chrome==null?void 0:chrome.history)!=null&&N.onVisited&&chrome.history.onVisited.addListener(t=>{const s=t.url||"",r=q(s);r&&$({query:r.query,engine:r.engine,url:s,visitedAt:t.lastVisitTime||Date.now()}).catch(()=>{})})}catch{}function J(t){return new Promise((s,r)=>{const e=new FileReader;e.onerror=()=>r(new Error("Failed to read blob")),e.onloadend=()=>{const o=e.result.split(",")[1]||"";s(o)},e.readAsDataURL(t)})}async function X(t){if(f!=="idle"){console.warn("[cue] Session already in progress");return}_=t,f="recording",console.log("[cue] Session recording started for:",t.title)}function B(){f==="recording"&&(f="paused",console.log("[cue] Session paused"))}function z(){f==="paused"&&(f="recording",console.log("[cue] Session resumed"))}async function K(t){try{console.log("[cue] Saving session, audio size:",t.audio_base64.length,"base64 chars");const s=await fetch(`${m}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,source_url:t.url,duration_seconds:t.duration,audio_base64:t.audio_base64,mime_type:t.mime_type})});if(!s.ok){let e=`HTTP ${s.status}: ${s.statusText}`;try{const n=await s.text();if(n)try{const o=JSON.parse(n);e=o.error||o.detail||e}catch{e=n.substring(0,200)}}catch(n){console.error("[cue] Failed to read error response:",n)}console.error("[cue] Backend error:",e),f="idle",_=null;try{const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});n!=null&&n.id&&chrome.tabs.sendMessage(n.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let r;try{const e=await s.text();if(!e)throw new Error("Empty response from server");r=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await s.text()),f="idle",_=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}_&&(_=null,f="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:r},n=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",r.sessionId),{success:!0,sessionId:r.sessionId}}catch(s){return console.error("[cue] Failed to save session:",s),f="idle",_=null,{success:!1,error:s.message||"Unknown error occurred"}}}function I(){return new Promise((t,s)=>{if((d==null?void 0:d.readyState)===WebSocket.OPEN){t(d);return}const r=new WebSocket(`${G}/ws/puppeteer`);r.onopen=()=>{console.log("Puppeteer WebSocket connected"),S=0,d=r,t(r)},r.onerror=e=>{console.error("Puppeteer WebSocket error:",e),s(e)},r.onclose=()=>{console.log("Puppeteer WebSocket closed"),d=null,l&&l.state==="recording"&&S<L&&(S++,setTimeout(()=>I().catch(console.error),1e3*S))},r.onmessage=async e=>{try{const n=JSON.parse(e.data),[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&(n.type==="pose"?chrome.tabs.sendMessage(o.id,{type:"POSE_UPDATE",payload:n}):n.type==="diagram"?chrome.tabs.sendMessage(o.id,{type:"DIAGRAM_RECEIVED",payload:n}):n.type==="motion"&&chrome.tabs.sendMessage(o.id,{type:"MOTION_DETECTED",payload:n}))}catch(n){console.error("Failed to parse WebSocket message:",n)}}})}async function Y(t,s){try{const r=await J(t);(d==null?void 0:d.readyState)===WebSocket.OPEN?d.send(JSON.stringify({type:"audio_chunk",audio_base64:r,mime_type:s,timestamp:Date.now()})):await Q(r,s)}catch(r){console.error("Failed to send audio chunk:",r)}}async function Q(t,s){const e=await(await fetch(`${m}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:t,mime_type:s})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(n!=null&&n.id){const o=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(n.id,{type:o,payload:e})}}}async function Z(){try{await I()}catch(t){console.warn("Could not establish WebSocket, will use HTTP fallback:",t)}return new Promise((t,s)=>{chrome.tabCapture.capture({audio:!0,video:!1},r=>{var n;if(chrome.runtime.lastError||!r){s(new Error(((n=chrome.runtime.lastError)==null?void 0:n.message)||"Failed to start tab capture"));return}w=r;const e={mimeType:"audio/webm;codecs=opus"};try{l=new MediaRecorder(r,e)}catch{l=new MediaRecorder(r)}l.ondataavailable=o=>{o.data&&o.data.size>0&&Y(o.data,(l==null?void 0:l.mimeType)||"audio/webm")},l.start(j),chrome.tabs.query({active:!0,currentWindow:!0}).then(([o])=>{o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"GO_LIVE_STARTED"})}),t()})})}function ee(){l&&l.state!=="inactive"&&l.stop(),w&&(w.getTracks().forEach(t=>t.stop()),w=null),l=null,d&&(d.close(),d=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((t,s,r)=>{if(t.type==="CONTEXT_GET_SNAPSHOT")return(async()=>{try{const e=await g();r({success:!0,context:e})}catch(e){r({success:!1,error:(e==null?void 0:e.message)||String(e)})}})(),!0;if(t.type==="CONTEXT_REFRESH_SEARCHES")return(async()=>{try{const e=await V(50),n=await W(e,50);r({success:!0,context:n})}catch(e){r({success:!1,error:(e==null?void 0:e.message)||String(e)})}})(),!0;if(t.type==="CONTEXT_CLEAR")return(async()=>{try{await M();const e=await g();r({success:!0,context:e})}catch(e){r({success:!1,error:(e==null?void 0:e.message)||String(e)})}})(),!0;if(t.type==="CONTEXT_SAVE_CHAT_MESSAGES")return(async()=>{var e,n,o;try{const c=((e=t.payload)==null?void 0:e.hostname)||"",a=(n=t.payload)==null?void 0:n.url,u=(((o=t.payload)==null?void 0:o.messages)||[]).map(p=>({role:p.role||"unknown",text:p.text,url:a})),i=await D(c,u,50);r({success:!0,context:i})}catch(c){r({success:!1,error:(c==null?void 0:c.message)||String(c)})}})(),!0;if(t.type==="CONTEXT_SUGGEST")return(async()=>{var e;try{await O();const n=await g(),o=A(n),a=["You are a proactive assistant inside a browser extension.","Using the user's recent search queries and recent AI chat messages, propose 3 suggestions.","Each suggestion should be one short paragraph and include a specific next step.","If the context is empty, respond with a single question asking what the user is working on.","",`Goal: ${((e=t.payload)==null?void 0:e.goal)||"Generate 3 helpful, concrete suggestions the user can take next."}`].join(`
`),i=await(await fetch(`${m}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:a,context_blob:o})})).json();r(i)}catch(n){r({success:!1,error:(n==null?void 0:n.message)||String(n)})}})(),!0;if(t.type==="CONTEXT_AUTO_SUGGEST")return(async()=>{var e,n;try{await O();const o=await g(),c=H(o),a=A(c,{maxSearches:50,maxMessagesPerHost:50}),u=Math.min(Math.max(((e=t.payload)==null?void 0:e.count)||5,1),10),i=((n=t.payload)==null?void 0:n.goal)||"Generate helpful suggestions the user can take next based on today's activity.",p=["You are a proactive assistant inside a browser extension.",`Using the user's activity from today only (searches + AI chats), propose ${u} suggestions.`,"Return a numbered list 1..N. Keep each suggestion short and concrete, with a next step.","If the context is empty, return a single question asking what the user is working on.","",`Goal: ${i}`].join(`
`),h=await(await fetch(`${m}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:p,context_blob:a})})).json();r(h)}catch(o){r({success:!1,error:(o==null?void 0:o.message)||String(o)})}})(),!0;if(t.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:t.url||"http://localhost:3001"}),r({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),r({success:!1,error:e.message})}return!0}if(t.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),n=!!t.includeContext;let o;if(n){const p=await g();o=A(p)}const c=t.conversationHistory,a={query:t.query,page_title:(e==null?void 0:e.title)||"",current_url:(e==null?void 0:e.url)||"",selected_text:t.selectedText||"",...o?{context_blob:o}:{},...c!=null&&c.length?{conversation_history:c}:{}},i=await(await fetch(`${m}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();r(i),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:i})}catch(e){r({success:!1,error:e.message})}})(),!0;if(t.type==="PRISM_SUMMARIZE")return fetch(`${m}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then(e=>e.json()).then(async e=>{r({status:"ok",data:e});const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});n!=null&&n.id&&chrome.tabs.sendMessage(n.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_START")return X(t.payload).then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_PAUSE"){B(),r({status:"ok"});return}if(t.type==="SESSION_RESUME"){z(),r({status:"ok"});return}if(t.type==="SESSION_STOP")return K(t.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;if(t.type==="GO_LIVE_START")return Z().then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="GO_LIVE_STOP"){ee(),r({status:"ok"});return}});
