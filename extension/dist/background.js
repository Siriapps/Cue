const m="http://localhost:8000",p="ws://localhost:8000";let c=null,f=null,i=null,l=0;const g=5,S=5e3;let a="idle",d=null;function E(t){return new Promise((n,r)=>{const e=new FileReader;e.onerror=()=>r(new Error("Failed to read blob")),e.onloadend=()=>{const s=e.result.split(",")[1]||"";n(s)},e.readAsDataURL(t)})}let u=null;async function b(t){const n=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[t]});if(n.length>0)try{fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:48",message:"Closing existing offscreen document",data:{documentId:n[0].documentId},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),await chrome.offscreen.closeDocument({documentId:n[0].documentId}),fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:52",message:"Offscreen document closed successfully",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),await new Promise(r=>setTimeout(r,200))}catch(r){fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:57",message:"Error closing offscreen document",data:{error:String(r)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})}if(u)await u;else{u=(async()=>{try{fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:62",message:"Creating new offscreen document",data:{path:t},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),await chrome.offscreen.createDocument({url:t,reasons:["USER_MEDIA"],justification:"Wake word detection and audio capture from tab"}),fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:70",message:"Offscreen document created successfully",data:{path:t},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})}catch(r){if(fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:73",message:"Error creating offscreen document",data:{error:r.message},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),!r.message.startsWith("Only a single offscreen"))throw console.error("[cue] Failed to create offscreen document:",r),r}})();try{await u}finally{u=null}}}async function T(t){if(a!=="idle"){console.warn("[cue] Session already in progress");return}d=t,a="recording",console.log("[cue] Session recording started for:",t.title)}function w(){a==="recording"&&(a="paused",console.log("[cue] Session paused"))}function O(){a==="paused"&&(a="recording",console.log("[cue] Session resumed"))}async function _(t){try{console.log("[cue] Saving session, audio size:",t.audio_base64.length,"base64 chars");const n=await fetch(`${m}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,source_url:t.url,duration_seconds:t.duration,audio_base64:t.audio_base64,mime_type:t.mime_type})});if(!n.ok){let e=`HTTP ${n.status}: ${n.statusText}`;try{const o=await n.text();if(o)try{const s=JSON.parse(o);e=s.error||s.detail||e}catch{e=o.substring(0,200)}}catch(o){console.error("[cue] Failed to read error response:",o)}console.error("[cue] Backend error:",e),a="idle",d=null;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let r;try{const e=await n.text();if(!e)throw new Error("Empty response from server");r=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await n.text()),a="idle",d=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}d&&(d=null,a="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:r},o=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",r.sessionId),{success:!0,sessionId:r.sessionId}}catch(n){return console.error("[cue] Failed to save session:",n),a="idle",d=null,{success:!1,error:n.message||"Unknown error occurred"}}}function y(){return new Promise((t,n)=>{if((i==null?void 0:i.readyState)===WebSocket.OPEN){t(i);return}const r=new WebSocket(`${p}/ws/puppeteer`);r.onopen=()=>{console.log("Puppeteer WebSocket connected"),l=0,i=r,t(r)},r.onerror=e=>{console.error("Puppeteer WebSocket error:",e),n(e)},r.onclose=()=>{console.log("Puppeteer WebSocket closed"),i=null,c&&c.state==="recording"&&l<g&&(l++,setTimeout(()=>y().catch(console.error),1e3*l))},r.onmessage=async e=>{try{const o=JSON.parse(e.data),[s]=await chrome.tabs.query({active:!0,currentWindow:!0});s!=null&&s.id&&(o.type==="pose"?chrome.tabs.sendMessage(s.id,{type:"POSE_UPDATE",payload:o}):o.type==="diagram"?chrome.tabs.sendMessage(s.id,{type:"DIAGRAM_RECEIVED",payload:o}):o.type==="motion"&&chrome.tabs.sendMessage(s.id,{type:"MOTION_DETECTED",payload:o}))}catch(o){console.error("Failed to parse WebSocket message:",o)}}})}async function I(t,n){try{const r=await E(t);(i==null?void 0:i.readyState)===WebSocket.OPEN?i.send(JSON.stringify({type:"audio_chunk",audio_base64:r,mime_type:n,timestamp:Date.now()})):await D(r,n)}catch(r){console.error("Failed to send audio chunk:",r)}}async function D(t,n){const e=await(await fetch(`${m}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:t,mime_type:n})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o!=null&&o.id){const s=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(o.id,{type:s,payload:e})}}}async function P(){try{await y()}catch(t){console.warn("Could not establish WebSocket, will use HTTP fallback:",t)}return new Promise((t,n)=>{chrome.tabCapture.capture({audio:!0,video:!1},r=>{var o;if(chrome.runtime.lastError||!r){n(new Error(((o=chrome.runtime.lastError)==null?void 0:o.message)||"Failed to start tab capture"));return}f=r;const e={mimeType:"audio/webm;codecs=opus"};try{c=new MediaRecorder(r,e)}catch{c=new MediaRecorder(r)}c.ondataavailable=s=>{s.data&&s.data.size>0&&I(s.data,(c==null?void 0:c.mimeType)||"audio/webm")},c.start(S),chrome.tabs.query({active:!0,currentWindow:!0}).then(([s])=>{s!=null&&s.id&&chrome.tabs.sendMessage(s.id,{type:"GO_LIVE_STARTED"})}),t()})})}function N(){c&&c.state!=="inactive"&&c.stop(),f&&(f.getTracks().forEach(t=>t.stop()),f=null),c=null,i&&(i.close(),i=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((t,n,r)=>{if(t.type==="START_WAKE_WORD")return b("offscreen.html").then(()=>{setTimeout(()=>{chrome.runtime.sendMessage({type:"START_WAKE_WORD",target:"offscreen"},e=>{var o;if(fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:381",message:"Received response from offscreen START_WAKE_WORD",data:{hasResponse:!!e,success:e==null?void 0:e.success,error:e==null?void 0:e.error,hasLastError:!!chrome.runtime.lastError,lastErrorMessage:(o=chrome.runtime.lastError)==null?void 0:o.message},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),chrome.runtime.lastError){console.warn("[cue] Failed to send START to offscreen:",chrome.runtime.lastError),r({success:!1,error:chrome.runtime.lastError.message});return}if(e&&!e.success){const s=e.error||"";fetch("http://127.0.0.1:7242/ingest/23f45ddd-244c-4bbc-b1ce-d6e960bc0c31",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:389",message:"Checking error type from offscreen",data:{error:s,isPermissionDenied:s==="PERMISSION_DENIED",hasPermission:s.includes("permission"),hasNotAllowed:s.includes("not-allowed"),hasDeviceNotFound:s.includes("not found")||s.includes("device")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),(s==="PERMISSION_DENIED"||s.includes("permission")||s.includes("not-allowed")||s.includes("Permission denied")||s.includes("not found")||s.includes("device")||s.includes("NotFoundError"))&&(console.warn("[cue] Wake word permission/device issue. Opening permission page."),chrome.tabs.create({url:chrome.runtime.getURL("permission.html")}))}r(e||{success:!1,error:"No response from offscreen"})})},100)}).catch(e=>{console.error("[cue] Failed to setup offscreen document:",e),r({success:!1,error:e.message})}),!0;if(t.type==="STOP_WAKE_WORD"){chrome.runtime.sendMessage({type:"STOP_WAKE_WORD",target:"offscreen"}),r({success:!0});return}if(t.type==="WAKE_WORD_DETECTED"){chrome.tabs.query({active:!0,currentWindow:!0}).then(([e])=>{e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"WAKE_WORD_DETECTED"})});return}if(t.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:t.url||"http://localhost:3001"}),r({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),r({success:!1,error:e.message})}return!0}if(t.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),o={query:t.query,page_title:(e==null?void 0:e.title)||"",current_url:(e==null?void 0:e.url)||"",selected_text:t.selectedText||""},h=await(await fetch(`${m}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json();r(h),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:h})}catch(e){r({success:!1,error:e.message})}})(),!0;if(t.type==="PRISM_SUMMARIZE")return fetch(`${m}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then(e=>e.json()).then(async e=>{r({status:"ok",data:e});const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_START")return T(t.payload).then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_PAUSE"){w(),r({status:"ok"});return}if(t.type==="SESSION_RESUME"){O(),r({status:"ok"});return}if(t.type==="SESSION_STOP")return _(t.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;if(t.type==="GO_LIVE_START")return P().then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="GO_LIVE_STOP"){N(),r({status:"ok"});return}if(t.type==="PERMISSION_GRANTED"){console.log("[cue] Permission granted, retrying wake word detection..."),setTimeout(()=>{chrome.runtime.sendMessage({type:"START_WAKE_WORD",target:"offscreen"},e=>{e&&e.success?console.log("[cue] Wake word detection restarted successfully after permission grant"):console.warn("[cue] Failed to restart wake word after permission grant:",e==null?void 0:e.error)}),chrome.tabs.query({},e=>{for(const o of e)o.id&&chrome.tabs.sendMessage(o.id,{type:"PERMISSION_UPDATED"},()=>{chrome.runtime.lastError})})},500),r({success:!0});return}});
