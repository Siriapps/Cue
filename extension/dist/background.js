const G="cue_context_v1";function y(){return Date.now()}function K(t){return t.replace(/\s+/g," ").trim()}function Y(t,r){return t.slice(0,r)}function Q(){var t;try{return((t=chrome==null?void 0:chrome.storage)==null?void 0:t.local)||null}catch{return null}}async function w(){const t=Q();return t?new Promise(r=>{t.get([G],o=>{const e=o==null?void 0:o[G];if(!e||typeof e!="object"){r({recent_searches:[],recent_ai_chats:{},recent_sites:[],updatedAt:y()});return}r({recent_searches:Array.isArray(e.recent_searches)?e.recent_searches:[],recent_ai_chats:e.recent_ai_chats&&typeof e.recent_ai_chats=="object"?e.recent_ai_chats:{},recent_sites:Array.isArray(e.recent_sites)?e.recent_sites:[],updatedAt:typeof e.updatedAt=="number"?e.updatedAt:y()})})}):{recent_searches:[],recent_ai_chats:{},recent_sites:[],updatedAt:y()}}async function x(t){const r=Q();if(r)return new Promise(o=>{r.set({[G]:{...t,updatedAt:y()}},()=>o())})}async function ie(){await x({recent_searches:[],recent_ai_chats:{},recent_sites:[],updatedAt:y()})}async function ue(t,r=50){const o=await w(),e=K(t.query);if(!e)return o;const s={...t,query:e,visitedAt:t.visitedAt||y()},c=o.recent_searches.filter(n=>!(n.query===s.query&&n.url===s.url)),a={...o,recent_searches:Y([s,...c],r),updatedAt:y()};return await x(a),a}async function le(t,r=50){const o=await w(),e=t.map(n=>({query:K(n.query||""),url:n.url,engine:n.engine,visitedAt:n.visitedAt||y()})).filter(n=>!!n.query&&!!n.url),s=new Set,c=[];for(const n of e){const i=`${n.query}@@${n.url}`;if(!s.has(i)&&(s.add(i),c.push(n),c.length>=r))break}const a={...o,recent_searches:c,updatedAt:y()};return await x(a),a}async function de(t,r,o=50){var h;const e=(t||"").trim().toLowerCase();if(!e)return w();const s=await w(),c=Array.isArray((h=s.recent_ai_chats)==null?void 0:h[e])?s.recent_ai_chats[e]:[],a=r.map(l=>({role:l.role||"unknown",text:K(l.text||"").slice(0,4e3),capturedAt:l.capturedAt||y(),url:l.url})).filter(l=>!!l.text),n=new Set,i=[...a,...c],d=[];for(const l of i){const $=`${l.role}@@${l.text}`;if(!n.has($)&&(n.add($),d.push(l),d.length>=o))break}const u={...s,recent_ai_chats:{...s.recent_ai_chats,[e]:d},updatedAt:y()};return await x(u),u}async function he(t,r=30){const o=await w();if(t.durationMs<1e4||["google.com","bing.com","duckduckgo.com","yahoo.com","ecosia.org"].some(n=>t.domain.includes(n)))return o;const s={url:t.url,title:(t.title||t.domain).slice(0,200),domain:t.domain,visitedAt:t.visitedAt||y(),durationMs:t.durationMs},c=(o.recent_sites||[]).filter(n=>n.url!==s.url),a={...o,recent_sites:Y([s,...c],r),updatedAt:y()};return await x(a),a}function j(t,r){var n;const c=[];c.push("Recent search queries (newest first):");for(const i of(t.recent_searches||[]).slice(0,10))c.push(`- ${i.query}${i.engine?` [${i.engine}]`:""}`);if((n=t.recent_sites)!=null&&n.length){c.push(`
Recent sites visited (>10s dwell time, newest first):`);for(const i of t.recent_sites.slice(0,10)){const d=Math.round(i.durationMs/1e3);c.push(`- ${i.title||i.domain} (${d}s)`)}}const a=Object.keys(t.recent_ai_chats||{}).sort();if(a.length){c.push(`
Recent AI chat messages (newest first):`);for(const i of a){const d=(t.recent_ai_chats[i]||[]).slice(0,12);if(d.length){c.push(`
Host: ${i}`);for(const u of d){const h=u.role||"unknown";c.push(`- ${h}: ${u.text}`)}}}}return c.join(`
`).trim()}const _="http://localhost:8000",Z="ws://localhost:8000";let f=null,N=null,p=null,v=0;const ge=5,me=5e3;let T="idle",C=null;async function ee(){try{const t=await chrome.identity.getAuthToken({interactive:!0}),r=typeof t=="string"?t:t==null?void 0:t.token;return r?(await chrome.storage.local.set({googleToken:r,tokenTimestamp:Date.now()}),console.log("[cue] Google token stored in chrome.storage.local"),{success:!0,token:r}):{success:!1,error:"No token returned"}}catch(t){return console.error("[cue] Google login failed:",t),{success:!1,error:(t==null?void 0:t.message)||"Login failed"}}}async function fe(){chrome.identity.clearAllCachedAuthTokens(),await chrome.storage.local.remove(["googleToken","tokenTimestamp"]),console.log("[cue] Google logout: tokens cleared")}async function pe(){return!!(await chrome.storage.local.get(["googleToken"])).googleToken}async function I(){try{const t=await chrome.identity.getAuthToken({interactive:!1}),r=typeof t=="string"?t:t==null?void 0:t.token;return r?(await chrome.storage.local.set({googleToken:r,tokenTimestamp:Date.now()}),console.log("[cue] Fresh token obtained"),r):(console.log("[cue] No cached token, attempting interactive login"),(await ee()).token||null)}catch(t){return console.error("[cue] Failed to get fresh token:",t),null}}function te(t){try{const o=new URL(t).hostname.toLowerCase();return o.includes("google.")?"Google":o.includes("bing.")?"Bing":o.includes("duckduckgo.")?"DuckDuckGo":o.includes("yahoo.")?"Yahoo":o.includes("ecosia.")?"Ecosia":void 0}catch{return}}function oe(t){var r,o,e,s;try{const c=new URL(t),a=c.hostname.toLowerCase(),n=c.searchParams.get("q")||c.searchParams.get("query")||c.searchParams.get("p")||c.searchParams.get("text");return n&&n.trim()?n.trim():a.includes("google.")?((r=c.searchParams.get("q"))==null?void 0:r.trim())??null:a.includes("bing.")?((o=c.searchParams.get("q"))==null?void 0:o.trim())??null:a.includes("duckduckgo.")?((e=c.searchParams.get("q"))==null?void 0:e.trim())??null:a.includes("yahoo.")?((s=c.searchParams.get("p"))==null?void 0:s.trim())??null:null}catch{return null}}async function ye(){const r=await new Promise(s=>{chrome.history.search({text:"",maxResults:200,startTime:0},s)}),o=[],e=new Set;for(const s of r){if(!s.url)continue;const c=oe(s.url);if(!c)continue;const a=`${c}@@${s.url}`;if(!e.has(a)&&(e.add(a),o.push({query:c,url:s.url,engine:te(s.url),visitedAt:s.lastVisitTime??Date.now()}),o.length>=50))break}return le(o,50)}chrome.history.onVisited.addListener(async t=>{if(!t.url)return;const r=oe(t.url);r&&(await ue({query:r,url:t.url,engine:te(t.url),visitedAt:t.lastVisitTime??Date.now()}),F(t.url,"search_query"))});const L={"github.com":"coding","stackoverflow.com":"coding","leetcode.com":"coding","codepen.io":"coding","codesandbox.io":"coding","replit.com":"coding","gitlab.com":"coding","bitbucket.org":"coding","npmjs.com":"coding","pypi.org":"coding","gmail.com":"email","mail.google.com":"email","outlook.com":"email","outlook.live.com":"email","mail.yahoo.com":"email","calendar.google.com":"calendar","outlook.office.com":"calendar","docs.google.com":"docs","sheets.google.com":"docs","slides.google.com":"docs","drive.google.com":"docs","notion.so":"docs","figma.com":"docs","twitter.com":"social","x.com":"social","linkedin.com":"social","facebook.com":"social","reddit.com":"social","amazon.com":"shopping","ebay.com":"shopping","etsy.com":"shopping","youtube.com":"video","netflix.com":"video","twitch.tv":"video","chat.openai.com":"ai","gemini.google.com":"ai","claude.ai":"ai","perplexity.ai":"ai","news.ycombinator.com":"news","techcrunch.com":"news","bbc.com":"news","cnn.com":"news"};let m="active",b="",M=0,P=[],U=0;const W=2*60*1e3,q=5*60*1e3,_e=6e4,re=5,A={},R={},g=[],se=10;let Te=0;function Se(t,r){const o=Date.now();if(g.length>0){const e=g[g.length-1];e.durationMs=o-e.timestamp,e.durationMs>=1e4&&he({url:e.url,title:e.title,domain:e.domain,visitedAt:e.timestamp,durationMs:e.durationMs}).catch(()=>{})}try{const s=new URL(t).hostname.replace("www.",""),c=ce(t);if(g.length>0&&g[g.length-1].url===t)return;for(g.push({url:t,title:r||s,domain:s,category:c,timestamp:o});g.length>se;)g.shift();Te=o,chrome.storage.local.set({urlTrajectory:g.slice()})}catch{}}function we(){if(g.length===0)return"";const t=g.map((r,o)=>{const e=Math.round((Date.now()-r.timestamp)/6e4),s=r.durationMs?` (${Math.round(r.durationMs/1e3)}s)`:"";return`${o+1}. [${r.category}] ${r.title}${s} - ${e}m ago`});return`Active Browsing Trajectory (last ${g.length} pages):
${t.join(`
`)}`}function V(){const t=[];g.forEach(o=>{t.push(o.category);const e=o.title.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(s=>s.length>3);t.push(...e.slice(0,5));try{const c=new URL(o.url).pathname.replace(/[^a-z0-9]/gi," ").toLowerCase().split(/\s+/).filter(a=>a.length>3);t.push(...c.slice(0,3))}catch{}});const r={};return t.forEach(o=>{r[o]=(r[o]||0)+1}),Object.entries(r).sort((o,e)=>e[1]-o[1]).slice(0,10).map(([o])=>o)}function z(t,r){return r.length===0?!1:t.filter(s=>r.includes(s)).length/Math.max(t.length,r.length)>.4}chrome.storage.local.get(["urlTrajectory"],t=>{t.urlTrajectory&&Array.isArray(t.urlTrajectory)&&(g.push(...t.urlTrajectory.slice(-se)),console.log(`[cue] Loaded ${g.length} trajectory entries from storage`))});function ce(t){try{const r=new URL(t).hostname.replace("www.","");if(L[r])return L[r];for(const[o,e]of Object.entries(L))if(r.includes(o)||r.endsWith("."+o))return e;return"general"}catch{return"general"}}function Ee(t){const r=ce(t),o=Date.now(),e=V();switch(m){case"cooldown":{if(o-M<W){const s=Math.round((W-(o-M))/1e3);return console.log(`[cue] State: COOLDOWN - ${s}s remaining`),!1}m="intent_check",console.log("[cue] State: COOLDOWN -> INTENT_CHECK")}case"intent_check":{if(!z(e,P)){console.log(`[cue] PIVOT DETECTED - topic changed from [${P.slice(0,3).join(", ")}] to [${e.slice(0,3).join(", ")}]`),m="active";break}return console.log("[cue] Same topic detected - entering LOCKOUT"),m="lockout",U=o,!1}case"lockout":{if(o-U<q){const s=Math.round((q-(o-U))/1e3);if(!z(e,P)){console.log("[cue] PIVOT in LOCKOUT - topic changed, resetting to ACTIVE"),m="active";break}return console.log(`[cue] State: LOCKOUT - ${s}s remaining (suppressing same-topic suggestions)`),!1}console.log("[cue] State: LOCKOUT -> ACTIVE"),m="active";break}}return r!==b?(console.log(`[cue] Auto-suggest: context changed from "${b}" to "${r}"`),b=r,M=o,P=e.slice(),m="cooldown",!0):(console.log(`[cue] Auto-suggest: same category "${r}", state: ${m}`),!1)}function ke(){M=Date.now(),m="cooldown",console.log("[cue] User viewed suggestions - entering COOLDOWN")}function F(t,r){Ee(t)&&(console.log(`[cue] Triggering auto-suggest (${r})`),Oe(r))}function Ae(t,r){A[t]&&clearTimeout(A[t]),R[t]=r,A[t]=setTimeout(()=>{R[t]===r&&F(r,"page_dwell"),delete A[t]},_e)}chrome.tabs.onUpdated.addListener((t,r,o)=>{r.status==="complete"&&o.url&&!o.url.startsWith("chrome://")&&(Se(o.url,o.title||""),Ae(t,o.url),F(o.url,"context_change"))});chrome.tabs.onRemoved.addListener(t=>{A[t]&&(clearTimeout(A[t]),delete A[t]),delete R[t]});async function Oe(t){try{const[r]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=await w();let e=j(o);const s=we();s&&(e=`${e}

${s}`),e.trim()||(console.log("[cue] Context empty, using current page only"),e=`Currently browsing: ${(r==null?void 0:r.title)||"Unknown page"}
URL: ${(r==null?void 0:r.url)||""}`),console.log(`[cue] Auto-suggest triggered by: ${t}`),console.log(`[cue] State machine: ${m}, trajectory: ${g.length} entries`);const a=await(await fetch(`${_}/suggest_tasks`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context_blob:e,page_title:(r==null?void 0:r.title)||"",current_url:(r==null?void 0:r.url)||"",trajectory:g.slice()})})).json();if(a.success&&a.tasks&&a.tasks.length>0){const n=a.tasks.slice(0,re);console.log(`[cue] Auto-suggest returned ${n.length} tasks (capped from ${a.tasks.length}):`,n.map(i=>i.title)),P=V(),r!=null&&r.id?(console.log(`[cue] Sending PREDICTED_TASKS_POPUP to tab ${r.id}`),chrome.tabs.sendMessage(r.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:n,trigger:t}}).then(()=>{console.log("[cue] PREDICTED_TASKS_POPUP sent successfully")}).catch(i=>{console.error("[cue] Failed to send PREDICTED_TASKS_POPUP:",i),chrome.tabs.query({},d=>{d.forEach(u=>{u.id&&u.url&&!u.url.startsWith("chrome://")&&chrome.tabs.sendMessage(u.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:n,trigger:t}}).catch(()=>{})})})})):console.log("[cue] No active tab id to send popup to")}else console.log("[cue] Auto-suggest returned no tasks or failed:",a.error||"empty")}catch(r){console.error("[cue] Auto-suggest error:",r)}}function Ce(t){return new Promise((r,o)=>{const e=new FileReader;e.onerror=()=>o(new Error("Failed to read blob")),e.onloadend=()=>{const c=e.result.split(",")[1]||"";r(c)},e.readAsDataURL(t)})}async function Pe(t){if(T!=="idle"){console.warn("[cue] Session already in progress");return}C=t,T="recording",console.log("[cue] Session recording started for:",t.title)}function Me(){T==="recording"&&(T="paused",console.log("[cue] Session paused"))}function xe(){T==="paused"&&(T="recording",console.log("[cue] Session resumed"))}async function $e(t){try{console.log("[cue] Saving session, audio size:",t.audio_base64.length,"base64 chars");const r=await fetch(`${_}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,source_url:t.url,duration_seconds:t.duration,audio_base64:t.audio_base64,mime_type:t.mime_type})});if(!r.ok){let e=`HTTP ${r.status}: ${r.statusText}`;try{const s=await r.text();if(s)try{const c=JSON.parse(s);e=c.error||c.detail||e}catch{e=s.substring(0,200)}}catch(s){console.error("[cue] Failed to read error response:",s)}console.error("[cue] Backend error:",e),T="idle",C=null;try{const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});s!=null&&s.id&&chrome.tabs.sendMessage(s.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let o;try{const e=await r.text();if(!e)throw new Error("Empty response from server");o=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await r.text()),T="idle",C=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}C&&(C=null,T="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:o},s=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",o.sessionId),{success:!0,sessionId:o.sessionId}}catch(r){return console.error("[cue] Failed to save session:",r),T="idle",C=null,{success:!1,error:r.message||"Unknown error occurred"}}}function ne(){return new Promise((t,r)=>{if((p==null?void 0:p.readyState)===WebSocket.OPEN){t(p);return}const o=new WebSocket(`${Z}/ws/puppeteer`);o.onopen=()=>{console.log("Puppeteer WebSocket connected"),v=0,p=o,t(o)},o.onerror=e=>{console.error("Puppeteer WebSocket error:",e),r(e)},o.onclose=()=>{console.log("Puppeteer WebSocket closed"),p=null,f&&f.state==="recording"&&v<ge&&(v++,setTimeout(()=>ne().catch(console.error),1e3*v))},o.onmessage=async e=>{try{const s=JSON.parse(e.data),[c]=await chrome.tabs.query({active:!0,currentWindow:!0});c!=null&&c.id&&(s.type==="pose"?chrome.tabs.sendMessage(c.id,{type:"POSE_UPDATE",payload:s}):s.type==="diagram"?chrome.tabs.sendMessage(c.id,{type:"DIAGRAM_RECEIVED",payload:s}):s.type==="motion"&&chrome.tabs.sendMessage(c.id,{type:"MOTION_DETECTED",payload:s}))}catch(s){console.error("Failed to parse WebSocket message:",s)}}})}async function De(t,r){try{const o=await Ce(t);await ae(o,r)}catch(o){console.error("Failed to send audio chunk:",o)}}async function ae(t,r){try{(p==null?void 0:p.readyState)===WebSocket.OPEN?p.send(JSON.stringify({type:"audio_chunk",audio_base64:t,mime_type:r,timestamp:Date.now()})):await ve(t,r)}catch(o){console.error("Failed to send audio chunk:",o)}}async function ve(t,r){const e=await(await fetch(`${_}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:t,mime_type:r})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});if(s!=null&&s.id){const c=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(s.id,{type:c,payload:e})}}}async function Ne(){try{await ne()}catch(r){console.warn("Could not establish WebSocket, will use HTTP fallback:",r)}const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id))throw new Error("No active tab");try{const r=await new Promise((o,e)=>{chrome.tabCapture.getMediaStreamId({targetTabId:t.id},s=>{var c;chrome.runtime.lastError?e(new Error(((c=chrome.runtime.lastError)==null?void 0:c.message)||"getMediaStreamId failed")):o(s)})});await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Tab audio capture for Go Live"}),await new Promise((o,e)=>{setTimeout(()=>{chrome.runtime.sendMessage({target:"offscreen",type:"START_CAPTURE",streamId:r,includeMic:!1},s=>{var c;chrome.runtime.lastError?e(new Error((c=chrome.runtime.lastError)==null?void 0:c.message)):s!=null&&s.success?o():e(new Error((s==null?void 0:s.error)||"START_CAPTURE failed"))})},150)}),chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STARTED"});return}catch(r){console.warn("[cue] Offscreen capture failed, falling back to tabCapture.capture:",r)}return new Promise((r,o)=>{chrome.tabCapture.capture({audio:!0,video:!1},e=>{var c;if(chrome.runtime.lastError||!e){o(new Error(((c=chrome.runtime.lastError)==null?void 0:c.message)||"Failed to start tab capture"));return}N=e;const s={mimeType:"audio/webm;codecs=opus"};try{f=new MediaRecorder(e,s)}catch{f=new MediaRecorder(e)}f.ondataavailable=a=>{a.data&&a.data.size>0&&De(a.data,(f==null?void 0:f.mimeType)||"audio/webm")},f.start(me),chrome.tabs.query({active:!0,currentWindow:!0}).then(([a])=>{a!=null&&a.id&&chrome.tabs.sendMessage(a.id,{type:"GO_LIVE_STARTED"})}),r()})})}async function be(){f&&f.state!=="inactive"&&f.stop(),N&&(N.getTracks().forEach(t=>t.stop()),N=null),f=null;try{await chrome.offscreen.hasDocument()&&chrome.runtime.sendMessage({target:"offscreen",type:"STOP_CAPTURE"},()=>{chrome.offscreen.closeDocument()})}catch{}p&&(p.close(),p=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((t,r,o)=>{if(t.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:t.url||"http://localhost:3001"}),o({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),o({success:!1,error:e.message})}return!0}if(t.type==="CONTEXT_GET_SNAPSHOT")return w().then(e=>o({success:!0,snapshot:e})).catch(e=>o({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_REFRESH_SEARCHES")return ye().then(e=>o({success:!0,snapshot:e})).catch(e=>o({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_CLEAR")return ie().then(()=>o({success:!0})).catch(e=>o({success:!1,error:String(e)})),!0;if(t.type==="CONTEXT_SAVE_CHAT_MESSAGES"){const{hostname:e,url:s,messages:c}=t.payload||{};return!e||!Array.isArray(c)?(o({success:!1,error:"Missing hostname or messages"}),!0):(de(e,c.map(a=>({role:a.role||"unknown",text:a.text,url:s}))).then(()=>o({success:!0})).catch(a=>o({success:!1,error:String(a)})),!0)}if(t.type==="CONTEXT_SUGGEST")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=await w(),c=j(s),a=(e==null?void 0:e.title)??"",n=(e==null?void 0:e.url)??"";if(!c.trim()&&!a&&!n){o({success:!1,error:"No context to suggest from"});return}const i=c.trim()||`Currently viewing: ${a}
${n}`,u=await(await fetch(`${_}/suggest_tasks`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context_blob:i,page_title:a,current_url:n})})).json();if(u.success&&u.tasks&&u.tasks.length>0){const h=u.tasks.length,l=h===1?u.tasks[0].title||"1 task":`${h} tasks`;o({success:!0,suggestion:`${l} added to AI Task Automation. View in dashboard.`,tasksCount:h,tasks:u.tasks})}else o({success:!1,error:u.error||"No tasks generated. Try more context."})}catch(e){o({success:!1,error:(e==null?void 0:e.message)||"Suggest failed"})}})(),!0;if(t.type==="EXECUTE_SUGGESTED_TASK")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=await I();if(!s){o({success:!1,error:"Please sign in with Google first.",requires_auth:!0}),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"TASK_EXECUTED",payload:{success:!1,error:"Please sign in with Google first."}});return}const{service:c,action:a,params:n,taskId:i}=t;if(c==="gemini_chat"||c==="antigravity"||c==="openai_studio"){console.log(`[cue] Auto-opening ${c} with context prompt`);const l=[];n!=null&&n.prompt?l.push(n.prompt):n!=null&&n.title?l.push(n.title):n!=null&&n.description?l.push(n.description):a&&l.push(a),e!=null&&e.title&&(e!=null&&e.url)&&l.push(`

Context: I was browsing "${e.title}" (${e.url})`),n!=null&&n.context&&l.push(`

Additional context: ${n.context}`);const $=l.join("");let E="",D="";if(c==="gemini_chat")E="https://gemini.google.com/app",D="Opened Gemini - prompt copied to clipboard, paste with Ctrl+V";else if(c==="antigravity"){E="https://labs.google.com/search",D="Prompt copied to clipboard - paste into Antigravity (Ctrl+V)";try{chrome.tabs.create({url:"antigravity://open"},k=>{setTimeout(()=>{k!=null&&k.id&&chrome.tabs.get(k.id,X=>{var B;X&&((B=X.url)!=null&&B.includes("antigravity://"))||chrome.tabs.remove(k.id).catch(()=>{})})},500)})}catch{}}else c==="openai_studio"&&(E="https://chat.openai.com/",D="Opened ChatGPT - prompt copied to clipboard, paste with Ctrl+V");if(e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COPY_TO_CLIPBOARD",payload:{text:$}}).catch(()=>{}),console.log(`[cue] Opening ${c} at: ${E}`),chrome.tabs.create({url:E}),i)try{await fetch(`${_}/suggested_tasks/${i}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"completed",open_url:E})})}catch(k){console.error("[cue] Failed to mark task as completed:",k)}const H={success:!0,message:D,open_url:E,promptCopied:!0};o(H),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"TASK_EXECUTED",payload:{...H,taskId:i}});return}let d=`${a}`;c==="gmail"&&n?d=`${a} email to ${n.to||""} subject ${n.subject||""}`:c==="docs"&&n?d=`${a} document titled ${n.title||""}`:c==="calendar"&&n?d=`${a} event ${n.title||n.summary||""}`:c==="tasks"&&n&&(d=`${a} task ${n.title||""}`);const h=await(await fetch(`${_}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:c,command:d,user_token:s,confirm:!0,suggested_params:n,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??""})})).json();if(h.success&&h.open_url&&(console.log(`[cue] Opening URL from task execution: ${h.open_url}`),chrome.tabs.create({url:h.open_url})),h.success&&i)try{await fetch(`${_}/suggested_tasks/${i}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"completed"})})}catch(l){console.error("[cue] Failed to mark task as completed:",l)}o(h),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"TASK_EXECUTED",payload:{...h,taskId:i}})}catch(e){console.error("[cue] Execute suggested task error:",e),o({success:!1,error:e.message})}})(),!0;if(t.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=t.query||"",c=s.match(/^@(gmail|calendar|tasks|docs|drive|sheets)\s+(.+)/i);if(c){const a=c[1].toLowerCase(),n=c[2],i=t.confirm?await I():(await chrome.storage.local.get(["googleToken"])).googleToken||"",h={...await(await fetch(`${_}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:a,command:n,user_token:i,confirm:t.confirm||!1,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json(),type:"command",service:a,original_query:s};o(h),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_RESULT",payload:h})}else{let a="";if(t.includeContext){const u=await w();a=j(u)}const n={query:s,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??"",context_blob:a||void 0},d=await(await fetch(`${_}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();o(d),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:d})}}catch(e){o({success:!1,error:e.message})}})(),!0;if(t.type==="EXECUTE_COMMAND")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=await I();if(!s){o({success:!1,error:"Please sign in with Google first.",requires_auth:!0}),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:{success:!1,error:"Please sign in with Google first."}});return}const a=await(await fetch(`${_}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:t.service,command:t.command,user_token:s,confirm:!0,page_title:(e==null?void 0:e.title)??t.pageTitle??"",current_url:(e==null?void 0:e.url)??t.currentUrl??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json();o(a),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:a})}catch(e){o({success:!1,error:e.message})}})(),!0;if(t.type==="PRISM_SUMMARIZE")return fetch(`${_}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then(e=>e.json()).then(async e=>{o({status:"ok",data:e});const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});s!=null&&s.id&&chrome.tabs.sendMessage(s.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>o({status:"error",error:e.message})),!0;if(t.type==="SESSION_START")return Pe(t.payload).then(()=>o({status:"ok"})).catch(e=>o({status:"error",error:e.message})),!0;if(t.type==="SESSION_PAUSE"){Me(),o({status:"ok"});return}if(t.type==="SESSION_RESUME"){xe(),o({status:"ok"});return}if(t.type==="SESSION_STOP")return $e(t.payload).then(e=>o(e)).catch(e=>o({success:!1,error:e.message})),!0;if(t.type==="GO_LIVE_START")return Ne().then(()=>o({status:"ok"})).catch(e=>o({status:"error",error:e.message})),!0;if(t.type==="GO_LIVE_STOP"){be(),o({status:"ok"});return}if(t.type==="AUDIO_CHUNK")return ae(t.chunk,t.mimeType||"audio/webm").then(()=>o({ok:!0})),!0;if(t.type==="GOOGLE_LOGIN")return ee().then(e=>o(e)).catch(e=>o({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="GOOGLE_LOGOUT")return fe().then(()=>o({success:!0})).catch(e=>o({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="CHECK_LOGIN")return pe().then(e=>o({loggedIn:e})).catch(()=>o({loggedIn:!1})),!0;if(t.type==="USER_VIEWED_SUGGESTIONS")return ke(),o({success:!0,state:m}),!0;if(t.type==="GET_TRAJECTORY")return o({success:!0,trajectory:g.slice(),keywords:V(),state:m}),!0;if(t.type==="GET_SUGGESTION_STATE"){const e=Date.now();let s=0,c=0;return m==="cooldown"?s=Math.max(0,W-(e-M)):m==="lockout"&&(c=Math.max(0,q-(e-U))),o({success:!0,state:m,lastCategory:b,lastKeywords:P.slice(0,5),cooldownRemaining:Math.round(s/1e3),lockoutRemaining:Math.round(c/1e3)}),!0}});let S=null,O=0;const Ue=5;function J(){if((S==null?void 0:S.readyState)!==WebSocket.OPEN)try{S=new WebSocket(`${Z}/ws/extension`),S.onopen=()=>{console.log("[cue] Task sync WebSocket connected"),O=0},S.onmessage=t=>{try{const r=JSON.parse(t.data);if(r.type==="SYNCED_TASKS"||r.type==="SUGGESTED_TASKS_UPDATE"){const o=r.tasks||[];o.length>0&&(console.log(`[cue] Received ${o.length} synced tasks from dashboard`),chrome.storage.local.set({syncedTasks:o.slice(0,50)}),chrome.tabs.query({active:!0,currentWindow:!0},([e])=>{e!=null&&e.id&&e.url&&!e.url.startsWith("chrome://")&&chrome.tabs.sendMessage(e.id,{type:"PREDICTED_TASKS_POPUP",payload:{tasks:o.slice(0,re),trigger:"sync"}}).catch(()=>{})}))}r.type==="ACTIVITY_UPDATE"&&console.log("[cue] Activity update from dashboard")}catch(r){console.error("[cue] Task sync message parse error:",r)}},S.onclose=t=>{if(S=null,t.wasClean?console.log("[cue] Task sync WebSocket closed cleanly"):O===0&&console.log("[cue] Task sync: Server not available (is Python server running?)"),O<Ue){O++;const r=Math.min(1e4*O,6e4);O===1&&console.log(`[cue] Will retry connection in ${r/1e3}s`),setTimeout(J,r)}else console.log("[cue] Task sync disabled - start server and reload extension to reconnect")},S.onerror=()=>{}}catch(t){console.error("[cue] Failed to create task sync WebSocket:",t)}}J();chrome.runtime.onStartup.addListener(()=>{console.log("[cue] Extension startup - connecting task sync"),J()});
