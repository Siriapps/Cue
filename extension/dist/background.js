const d="http://localhost:8000",O="ws://localhost:8000";let c=null,p=null,i=null,y=0;const k=5,M=5e3;let u="idle",f=null;async function E(){try{const t=await chrome.identity.getAuthToken({interactive:!0}),s=typeof t=="string"?t:t==null?void 0:t.token;return s?(await chrome.storage.local.set({googleToken:s,tokenTimestamp:Date.now()}),console.log("[cue] Google token stored in chrome.storage.local"),{success:!0,token:s}):{success:!1,error:"No token returned"}}catch(t){return console.error("[cue] Google login failed:",t),{success:!1,error:(t==null?void 0:t.message)||"Login failed"}}}async function A(){chrome.identity.clearAllCachedAuthTokens(),await chrome.storage.local.remove(["googleToken","tokenTimestamp"]),console.log("[cue] Google logout: tokens cleared")}async function N(){return!!(await chrome.storage.local.get(["googleToken"])).googleToken}async function _(){try{const t=await chrome.identity.getAuthToken({interactive:!1}),s=typeof t=="string"?t:t==null?void 0:t.token;return s?(await chrome.storage.local.set({googleToken:s,tokenTimestamp:Date.now()}),console.log("[cue] Fresh token obtained"),s):(console.log("[cue] No cached token, attempting interactive login"),(await E()).token||null)}catch(t){return console.error("[cue] Failed to get fresh token:",t),null}}const P=10;let l=[],m={};const C=3e4;function I(t,s,r){const e=Date.now();l.length>0&&l[l.length-1].url===t||(l.push({url:t,title:s,timestamp:e}),l.length>P&&l.shift(),r!=null&&(m[r]&&clearTimeout(m[r]),m[r]=setTimeout(()=>{b(t),delete m[r]},C)))}async function b(t){try{const r=await(await fetch(`${d}/analyze_trajectory`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({trajectory:l,current_url:t})})).json(),e=r==null?void 0:r.prediction;if(e!=null&&e.next_step&&((e==null?void 0:e.confidence)??0)>=.8){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"PREDICTIVE_NUDGE",payload:{next_step:e.next_step,mcp_tool:e.mcp_tool,reasoning:e.reasoning}})}}catch(s){console.warn("[cue] analyze_trajectory failed:",s)}}chrome.tabs.onUpdated.addListener((t,s,r)=>{s.status==="complete"&&r.url&&!r.url.startsWith("chrome://")&&I(r.url,r.title||"",t)});function D(t){return new Promise((s,r)=>{const e=new FileReader;e.onerror=()=>r(new Error("Failed to read blob")),e.onloadend=()=>{const n=e.result.split(",")[1]||"";s(n)},e.readAsDataURL(t)})}async function v(t){if(u!=="idle"){console.warn("[cue] Session already in progress");return}f=t,u="recording",console.log("[cue] Session recording started for:",t.title)}function U(){u==="recording"&&(u="paused",console.log("[cue] Session paused"))}function G(){u==="paused"&&(u="recording",console.log("[cue] Session resumed"))}async function W(t){try{console.log("[cue] Saving session, audio size:",t.audio_base64.length,"base64 chars");const s=await fetch(`${d}/sessions/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t.title,source_url:t.url,duration_seconds:t.duration,audio_base64:t.audio_base64,mime_type:t.mime_type})});if(!s.ok){let e=`HTTP ${s.status}: ${s.statusText}`;try{const o=await s.text();if(o)try{const n=JSON.parse(o);e=n.error||n.detail||e}catch{e=o.substring(0,200)}}catch(o){console.error("[cue] Failed to read error response:",o)}console.error("[cue] Backend error:",e),u="idle",f=null;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"SESSION_SAVE_ERROR",payload:{error:e}},()=>{chrome.runtime.lastError})}catch{}return{success:!1,error:e}}let r;try{const e=await s.text();if(!e)throw new Error("Empty response from server");r=JSON.parse(e)}catch(e){return console.error("[cue] Failed to parse JSON response:",e),console.error("[cue] Response text:",await s.text()),u="idle",f=null,{success:!1,error:`Invalid JSON response: ${e.message}`}}f&&(f=null,u="idle");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"SESSION_SAVED",payload:r},o=>{chrome.runtime.lastError&&console.warn("[cue] Failed to notify content script:",chrome.runtime.lastError.message)})}catch(e){console.warn("[cue] Failed to send message to content script:",e.message)}return console.log("[cue] Session saved successfully:",r.sessionId),{success:!0,sessionId:r.sessionId}}catch(s){return console.error("[cue] Failed to save session:",s),u="idle",f=null,{success:!1,error:s.message||"Unknown error occurred"}}}function w(){return new Promise((t,s)=>{if((i==null?void 0:i.readyState)===WebSocket.OPEN){t(i);return}const r=new WebSocket(`${O}/ws/puppeteer`);r.onopen=()=>{console.log("Puppeteer WebSocket connected"),y=0,i=r,t(r)},r.onerror=e=>{console.error("Puppeteer WebSocket error:",e),s(e)},r.onclose=()=>{console.log("Puppeteer WebSocket closed"),i=null,c&&c.state==="recording"&&y<k&&(y++,setTimeout(()=>w().catch(console.error),1e3*y))},r.onmessage=async e=>{try{const o=JSON.parse(e.data),[n]=await chrome.tabs.query({active:!0,currentWindow:!0});n!=null&&n.id&&(o.type==="pose"?chrome.tabs.sendMessage(n.id,{type:"POSE_UPDATE",payload:o}):o.type==="diagram"?chrome.tabs.sendMessage(n.id,{type:"DIAGRAM_RECEIVED",payload:o}):o.type==="motion"&&chrome.tabs.sendMessage(n.id,{type:"MOTION_DETECTED",payload:o}))}catch(o){console.error("Failed to parse WebSocket message:",o)}}})}async function L(t,s){try{const r=await D(t);await S(r,s)}catch(r){console.error("Failed to send audio chunk:",r)}}async function S(t,s){try{(i==null?void 0:i.readyState)===WebSocket.OPEN?i.send(JSON.stringify({type:"audio_chunk",audio_base64:t,mime_type:s,timestamp:Date.now()})):await j(t,s)}catch(r){console.error("Failed to send audio chunk:",r)}}async function j(t,s){const e=await(await fetch(`${d}/process_audio_chunk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_base64:t,mime_type:s})})).json();if((e==null?void 0:e.type)==="diagram"||(e==null?void 0:e.type)==="pose"||(e==null?void 0:e.type)==="motion"){const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o!=null&&o.id){const n=e.type==="diagram"?"DIAGRAM_RECEIVED":e.type==="pose"?"POSE_UPDATE":"MOTION_DETECTED";chrome.tabs.sendMessage(o.id,{type:n,payload:e})}}}async function x(){try{await w()}catch(s){console.warn("Could not establish WebSocket, will use HTTP fallback:",s)}const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id))throw new Error("No active tab");try{const s=await new Promise((r,e)=>{chrome.tabCapture.getMediaStreamId({targetTabId:t.id},o=>{var n;chrome.runtime.lastError?e(new Error(((n=chrome.runtime.lastError)==null?void 0:n.message)||"getMediaStreamId failed")):r(o)})});await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Tab audio capture for Go Live"}),await new Promise((r,e)=>{setTimeout(()=>{chrome.runtime.sendMessage({target:"offscreen",type:"START_CAPTURE",streamId:s,includeMic:!1},o=>{var n;chrome.runtime.lastError?e(new Error((n=chrome.runtime.lastError)==null?void 0:n.message)):o!=null&&o.success?r():e(new Error((o==null?void 0:o.error)||"START_CAPTURE failed"))})},150)}),chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STARTED"});return}catch(s){console.warn("[cue] Offscreen capture failed, falling back to tabCapture.capture:",s)}return new Promise((s,r)=>{chrome.tabCapture.capture({audio:!0,video:!1},e=>{var n;if(chrome.runtime.lastError||!e){r(new Error(((n=chrome.runtime.lastError)==null?void 0:n.message)||"Failed to start tab capture"));return}p=e;const o={mimeType:"audio/webm;codecs=opus"};try{c=new MediaRecorder(e,o)}catch{c=new MediaRecorder(e)}c.ondataavailable=a=>{a.data&&a.data.size>0&&L(a.data,(c==null?void 0:c.mimeType)||"audio/webm")},c.start(M),chrome.tabs.query({active:!0,currentWindow:!0}).then(([a])=>{a!=null&&a.id&&chrome.tabs.sendMessage(a.id,{type:"GO_LIVE_STARTED"})}),s()})})}async function R(){c&&c.state!=="inactive"&&c.stop(),p&&(p.getTracks().forEach(t=>t.stop()),p=null),c=null;try{await chrome.offscreen.hasDocument()&&chrome.runtime.sendMessage({target:"offscreen",type:"STOP_CAPTURE"},()=>{chrome.offscreen.closeDocument()})}catch{}i&&(i.close(),i=null),chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&chrome.tabs.sendMessage(t.id,{type:"GO_LIVE_STOPPED"})})}chrome.runtime.onMessage.addListener((t,s,r)=>{if(t.type==="OPEN_LIBRARY"){try{chrome.tabs.create({url:t.url||"http://localhost:3001"}),r({success:!0})}catch(e){console.error("[cue] Failed to open library:",e),r({success:!1,error:e.message})}return!0}if(t.type==="ASK_AI")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=t.query||"",n=o.match(/^@(gmail|calendar|tasks|docs|drive|sheets)\s+(.+)/i);if(n){const a=n[1].toLowerCase(),g=n[2],h=t.confirm?await _():(await chrome.storage.local.get(["googleToken"])).googleToken||"",T={...await(await fetch(`${d}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:a,command:g,user_token:h,confirm:t.confirm||!1,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json(),type:"command",service:a,original_query:o};r(T),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_RESULT",payload:T})}else{const a={query:o,page_title:(e==null?void 0:e.title)??"",current_url:(e==null?void 0:e.url)??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""},h=await(await fetch(`${d}/ask_ai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();r(h),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"AI_ANSWER",payload:h})}}catch(e){r({success:!1,error:e.message})}})(),!0;if(t.type==="EXECUTE_COMMAND")return(async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=await _();if(!o){r({success:!1,error:"Please sign in with Google first.",requires_auth:!0}),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:{success:!1,error:"Please sign in with Google first."}});return}const a=await(await fetch(`${d}/execute_command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:t.service,command:t.command,user_token:o,confirm:!0,page_title:(e==null?void 0:e.title)??t.pageTitle??"",current_url:(e==null?void 0:e.url)??t.currentUrl??"",selected_text:t.selectedText??"",user_display_name:t.userDisplayName??"",user_email:t.userEmail??""})})).json();r(a),e!=null&&e.id&&chrome.tabs.sendMessage(e.id,{type:"COMMAND_EXECUTED",payload:a})}catch(e){r({success:!1,error:e.message})}})(),!0;if(t.type==="PRISM_SUMMARIZE")return fetch(`${d}/summarize_context`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.payload)}).then(e=>e.json()).then(async e=>{r({status:"ok",data:e});const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{type:"PRISM_RESULT",payload:e})}).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_START")return v(t.payload).then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="SESSION_PAUSE"){U(),r({status:"ok"});return}if(t.type==="SESSION_RESUME"){G(),r({status:"ok"});return}if(t.type==="SESSION_STOP")return W(t.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;if(t.type==="GO_LIVE_START")return x().then(()=>r({status:"ok"})).catch(e=>r({status:"error",error:e.message})),!0;if(t.type==="GO_LIVE_STOP"){R(),r({status:"ok"});return}if(t.type==="AUDIO_CHUNK")return S(t.chunk,t.mimeType||"audio/webm").then(()=>r({ok:!0})),!0;if(t.type==="GOOGLE_LOGIN")return E().then(e=>r(e)).catch(e=>r({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="GOOGLE_LOGOUT")return A().then(()=>r({success:!0})).catch(e=>r({success:!1,error:e==null?void 0:e.message})),!0;if(t.type==="CHECK_LOGIN")return N().then(e=>r({loggedIn:e})).catch(()=>r({loggedIn:!1})),!0});
